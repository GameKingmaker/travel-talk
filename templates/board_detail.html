{% extends "base.html" %}
{% set page_title = post.title ~ " | ì¼ë°˜ê²Œì‹œíŒ - ì¼ë³¸ ì—¬í–‰ íšŒí™” ê³µë¶€ë°©" %}
{% set page_desc = (post.content or "")[:120] ~ "..." %}

{% block content %}

<style>
  /* =========================
     NAVER CAFE-ish UI (board_detail only)
     ========================= */

  .bd-wrap{ max-width: 1040px; margin: 0 auto; }

  .bd-top{
    display:flex; justify-content:space-between; align-items:flex-start;
    gap:16px; margin-bottom:14px;
  }
  .bd-title{
    margin:0; font-size:26px; font-weight:900; letter-spacing:-0.2px;
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  }
  .bd-meta{
    margin-top:8px;
    display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    color:#667085; font-size:13px;
  }
  .bd-meta .dot{ color:#cbd5e1; }

  .bd-actions{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  }
  .bd-actions .btn{ border-radius:12px; height:40px; padding:0 12px; }

  .bd-card{
    background:#fff;
    border:1px solid #e6ebf7;
    border-radius:18px;
    box-shadow: 0 10px 30px rgba(16,24,40,.06);
    overflow:hidden;
  }
  .bd-card-inner{ padding:18px; }

  /* âœ… ì—¬ëŸ¬ ì´ë¯¸ì§€: ë¬´ì¡°ê±´ 1ì¤„ 1ì¥(ì„¸ë¡œ ì •ë ¬) */
  .bd-images{
    display:flex;
    flex-direction:column;
    gap:14px;
    margin: 0 0 14px;
  }
  .bd-image-item{
    width:100%;
    border-radius:14px;
    overflow:hidden;
    border:1px solid #e5e7eb;
    box-shadow: 0 10px 24px rgba(2,8,23,.08);
    background:#fff;
    display:block;
  }
  .bd-image-item img{
    display:block;
    width:100%;
    height:auto;
  }

  .bd-content{
    white-space:pre-wrap;
    line-height:1.8;
    font-size:15px;
    color:#101828;
    word-break:break-word;
  }

  .bd-divider{
    margin:18px 0;
    border:none;
    border-top:1px solid #e9edf5;
  }

  .bd-section-title{
    margin:0 0 10px;
    font-size:18px;
    font-weight:900;
    letter-spacing:-0.2px;
  }

  /* ëŒ“ê¸€ ì‘ì„± */
  .cmt-box{
    background:#fff;
    border:1px solid #e6ebf7;
    border-radius:16px;
    padding:14px;
  }
  .cmt-form{
    display:flex; gap:10px; align-items:flex-start;
  }
  .cmt-form textarea{
    flex:1;
    resize:none;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid #d7deee;
    outline:none;
    line-height:1.6;
    font-size:14px;
    background:#fbfdff;
  }
  .cmt-form textarea:focus{
    border-color:#bcd3ff;
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    background:#fff;
  }
  .cmt-form .btn{
    height:44px; border-radius:12px; padding:0 14px;
    white-space:nowrap;
  }

  /* ì¶”ì²œ ì˜ì—­ */
  .upvote-row{
    margin-top:12px;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  }
  .upvote-row #upvoteBtn{
    height:40px;
    border-radius:999px;
    padding:0 14px;
    font-weight:800;
  }
  .upvote-hint{
    font-size:13px; color:#60708a;
    padding:10px 12px;
    border-radius:12px;
    background:#f6f8ff;
    border:1px solid #e1e7f5;
  }

  /* ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ */
  .cmt-list{
    margin-top:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .cmt-item{
    padding:12px 14px;
    border:1px solid #e6ebf7;
    border-radius:16px;
    background:#fff;
  }
  .cmt-head{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
  }
  .cmt-who{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    min-width:0;
  }
  .cmt-grade{
    padding:4px 10px;
    border-radius:999px;
    background:#eef4ff;
    border:1px solid #cfe0ff;
    font-size:12px;
    font-weight:800;
    color:#1d4ed8;
    flex:0 0 auto;
  }
  .cmt-nick{ font-weight:900; color:#101828; }
  .cmt-time{ color:#7b879d; font-size:12px; white-space:nowrap; }
  .cmt-body{
    margin-top:8px;
    white-space:pre-wrap;
    line-height:1.6;
    color:#101828;
    word-break:break-word;
    font-size:14px;
  }
  .cmt-del .btn{
    padding:6px 10px;
    border-radius:10px;
    height:32px;
  }

  /* ê³µì§€ ì•ˆë‚´ */
  .notice-lock{
    padding:14px 16px;
    border:1px solid #e1e7f5;
    border-radius:14px;
    background:#f6f8ff;
    color:#475467;
    font-weight:700;
  }

  @media (max-width: 760px){
    .bd-top{ flex-direction:column; }
    .bd-actions{ width:100%; justify-content:flex-start; }
    .bd-title{ font-size:22px; }
    .bd-wrap{ padding: 0 2px; }
    .bd-images{ gap:10px; }
  }
</style>

<div class="bd-wrap">

  <!-- =========================
       ìƒë‹¨: ì œëª© + ë©”íƒ€ + ë²„íŠ¼
       ========================= -->
  <div class="bd-top">
    <div style="min-width:0; flex:1;">
      <h1 class="bd-title">
        {% if post.is_notice == 1 %}
          <span class="pill" style="background:#fff7ed; border:1px solid #fdba74; color:#9a3412;">ê³µì§€</span>
        {% endif %}
        <span style="min-width:0; overflow:hidden; text-overflow:ellipsis;">{{ post.title }}</span>
      </h1>

      <div class="bd-meta">
        <span class="grade">{{ post.author_grade }}</span>
        <span class="nick" style="font-weight:900;">{{ post.author_nickname }}</span>
        <span class="dot">Â·</span>
        <span>{{ post.created_at|mmdd }}</span>
        <span class="dot">Â·</span>
        <span>ì¡°íšŒ {{ post.views }}</span>
      </div>
    </div>

    <div class="bd-actions">
      <a class="btn" href="{{ url_for('board') }}">ëª©ë¡</a>

      {% if is_owner %}
        <a class="btn btn-primary" href="{{ url_for('board_edit', post_id=post.id) }}">ìˆ˜ì •</a>

        <form method="POST" action="{{ url_for('board_delete', post_id=post.id) }}"
              onsubmit="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?');" style="display:inline;">
          <button type="submit" class="btn btn-danger">ì‚­ì œ</button>
        </form>
      {% endif %}
    </div>
  </div>

  <!-- =========================
       ë³¸ë¬¸ ì¹´ë“œ
       ========================= -->
  <div class="bd-card">
    <div class="bd-card-inner">

      {# âœ… ì´ë¯¸ì§€ ì¶œë ¥ ê·œì¹™
         1) imagesê°€ ìˆìœ¼ë©´ imagesë§Œ ì¶œë ¥ (thumb_urlì€ ì¤‘ë³µ ë°©ì§€ ìœ„í•´ ì•ˆ ë³´ì—¬ì¤Œ)
         2) imagesê°€ ì—†ìœ¼ë©´ thumb_url 1ì¥ë§Œ ì¶œë ¥
      #}
      {% if images and images|length > 0 %}
        {% set shown = [] %}
        <div class="bd-images">
          {% for url in images %}
            {% if url and (url not in shown) %}
              {% set _ = shown.append(url) %}
              <a href="{{ url }}" target="_blank" class="bd-image-item">
                <img src="{{ url }}" alt="image">
              </a>
            {% endif %}
          {% endfor %}
        </div>
      {% elif post.thumb_url %}
        <div class="bd-images">
          <a href="{{ post.thumb_url }}" target="_blank" class="bd-image-item">
            <img src="{{ post.thumb_url }}" alt="image">
          </a>
        </div>
      {% endif %}

      <div class="bd-content">{{ post.content | e }}</div>

    </div>
  </div>

  {# =========================
     ê³µì§€ê¸€ì´ë©´ ëŒ“ê¸€/ì¶”ì²œ ë¹„í™œì„±í™”(ì•„ì˜ˆ ì•ˆ ë³´ì´ê²Œ)
     ========================= #}

  {% if post.is_notice == 1 %}

    <hr class="bd-divider">

    <div class="notice-lock">
      ê³µì§€ê¸€ì—ëŠ” ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </div>

  {% else %}

    <hr class="bd-divider">

    <h3 class="bd-section-title">ëŒ“ê¸€</h3>

    <!-- ëŒ“ê¸€ ì‘ì„± ë°•ìŠ¤ -->
    <div class="cmt-box">
      {% if user %}
        <form method="POST" action="{{ url_for('board_comment_create', post_id=post.id) }}" class="cmt-form">
          <textarea name="content" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          <button class="btn btn-primary" type="submit">ë“±ë¡</button>
        </form>
      {% else %}
        <div class="upvote-hint">
          ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´
          <a href="{{ url_for('login', next=url_for('board_detail', post_id=post.id)) }}">ë¡œê·¸ì¸</a>
          í•´ì£¼ì„¸ìš”.
        </div>
      {% endif %}

      <!-- ì¶”ì²œ -->
      {% if user %}
        <div class="upvote-row">
          <button
            id="upvoteBtn"
            class="btn btn-primary"
            type="button"
            {% if user_has_upvoted %}disabled{% endif %}
            style="{% if user_has_upvoted %}opacity:.6; cursor:not-allowed;{% endif %}"
          >
            ğŸ‘ ì¶”ì²œ <span id="upvoteCount">{{ post.upvotes or 0 }}</span>
          </button>

          <div id="upvoteMsg" class="upvote-hint" style="margin:0;">
            {% if user_has_upvoted %}
              ì´ë¯¸ ì¶”ì²œí•œ ê¸€ì´ì—ìš”.
            {% else %}
              ì¶”ì²œì€ ê¸€ë‹¹ 1íšŒë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="upvote-hint" style="margin-top:12px;">
          ì¶”ì²œí•˜ë ¤ë©´
          <a href="{{ url_for('login', next=url_for('board_detail', post_id=post.id)) }}">ë¡œê·¸ì¸</a>
          í•´ì£¼ì„¸ìš”.
        </div>
      {% endif %}
    </div>

    <script>
      const btn = document.getElementById("upvoteBtn");
      const countEl = document.getElementById("upvoteCount");
      const msgEl = document.getElementById("upvoteMsg");

      if (btn) {
        btn.addEventListener("click", async () => {
          if (btn.disabled) return;

          msgEl.textContent = "ì²˜ë¦¬ ì¤‘...";
          btn.disabled = true;
          btn.style.opacity = "0.6";
          btn.style.cursor = "not-allowed";

          try {
            const res = await fetch(`/board/{{ post.id }}/upvote`, { method: "POST" });
            const data = await res.json().catch(() => ({}));

            if (data.upvotes !== undefined) countEl.textContent = data.upvotes;

            if (res.ok && data.ok) {
              msgEl.textContent = data.msg || "ì¶”ì²œ ì™„ë£Œ!";
              btn.disabled = true;
            } else {
              msgEl.textContent = data.msg || "ì¶”ì²œí•  ìˆ˜ ì—†ì–´ìš”.";
              btn.disabled = true;
            }
          } catch (e) {
            msgEl.textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            btn.disabled = true;
          }
        });
      }
    </script>

    <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
    <div class="cmt-list">
      {% if comments and comments|length > 0 %}
        {% for c in comments %}
          <div class="cmt-item">
            <div class="cmt-head">
              <div class="cmt-who">
                <span class="cmt-grade">{{ c.author_grade }}</span>
                <span class="cmt-nick">{{ c.author_nickname }}</span>

                {% set dt = (c.created_at or '') %}
                <span class="cmt-time">
                  {{ dt[5:7] }}/{{ dt[8:10] }} {{ dt[11:16] }}
                </span>
              </div>

              {% if c.is_owner %}
                <form class="cmt-del" method="POST" action="{{ url_for('board_comment_delete', comment_id=c.id) }}"
                      onsubmit="return confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?');">
                  <button type="submit" class="btn">ì‚­ì œ</button>
                </form>
              {% endif %}
            </div>

            <div class="cmt-body">{{ c.content }}</div>
          </div>
        {% endfor %}
      {% else %}
        <div style="padding:14px; border:1px dashed #d9e2f5; border-radius:14px; color:#6b7a99; background:#fff;">
          ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      {% endif %}
    </div>

  {% endif %}

</div>

{% endblock %}
