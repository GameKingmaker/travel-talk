{% extends "base.html" %}

{# ✅ SEO: 게임/입력형 퀴즈는 검색노출 굳이 필요 없으면 noindex 추천 #}
{% set page_title = (quiz.scene_title ~ " | 발음 타이핑 - 일본 여행 회화 공부방") %}
{% set page_desc = "상대 말풍선을 보고 발음(한글)로 입력하는 타이핑 퀴즈입니다." %}
{% set page_robots = "noindex,nofollow" %}

{% block content %}

<section class="page-head">
  <h1>{{ (quiz.scene_title or "대화 타이핑") | e }}</h1>
  <p class="page-guide">
    상대 말풍선(일본어/발음)을 보고, 내 말풍선에 <b>발음(한글)</b>로 입력하세요. (띄어쓰기/기호 무시)
  </p>
</section>

<div class="dialog-wrap">
  <div class="scene">
    {# ✅ static 경로 기준으로 통일 (quiz.image가 파일명이어야 함) #}
    <img src="{{ url_for('static', filename=quiz.image) }}"
         alt="{{ (quiz.scene_title or 'scene') | e }}"
         class="scene-img">
  </div>

  <div class="bubbles">

    <!-- 상대방 말풍선: 일본어 + 발음 -->
    <div class="bubble partner">
      <div class="jp">{{ (quiz.partner_jp or "") | e }}</div>
      <div class="pron">{{ (quiz.partner_pron or "") | e }}</div>
    </div>

    <!-- 내 말풍선: 발음 입력 -->
    <div class="bubble me">
      <div class="label">내 답변(발음 입력)</div>

      <input id="userInput" class="answer-input"
             placeholder="예) 아리가또고자이마스"
             autocomplete="off" autocapitalize="off" spellcheck="false">

      <button id="checkBtn" class="check-btn" type="button">정답 확인</button>

      <div id="result" class="result" aria-live="polite"></div>

      <!-- 공부용 공개 영역 -->
      <div id="reveal" class="reveal" style="display:none;">
        <div><b>정답 발음:</b> <span id="rvPron"></span></div>
        <div><b>정답 일본어:</b> <span id="rvJp"></span></div>
        <div><b>뜻:</b> <span id="rvKo"></span></div>
      </div>
    </div>

  </div>
</div>

<script>
  (function(){
    const checkBtn = document.getElementById("checkBtn");
    const userInput = document.getElementById("userInput");
    const result = document.getElementById("result");

    const reveal = document.getElementById("reveal");
    const rvPron = document.getElementById("rvPron");
    const rvJp = document.getElementById("rvJp");
    const rvKo = document.getElementById("rvKo");

    let busy = false;

    function setBusy(isBusy){
      busy = isBusy;
      checkBtn.disabled = isBusy;
      checkBtn.textContent = isBusy ? "확인 중..." : "정답 확인";
      checkBtn.style.opacity = isBusy ? "0.75" : "1";
      checkBtn.style.cursor = isBusy ? "not-allowed" : "pointer";
    }

    async function submit(){
      if (busy) return;

      const val = (userInput.value || "").trim();
      if (!val){
        result.textContent = "입력해 주세요!";
        userInput.focus();
        return;
      }

      result.textContent = "";
      reveal.style.display = "none";

      try{
        setBusy(true);

        // ✅ 정답을 프론트에서 보내지 않음: user_input만 전송
        const fd = new FormData();
        fd.append("user_input", val);

        const res = await fetch("/games/dialog_typing/check_pron", {
          method: "POST",
          body: fd
        });

        if (!res.ok){
          result.textContent = "오류가 발생했어요.";
          return;
        }

        const data = await res.json();

        if (data.ok) {
          result.textContent = "✅ 정답!";
        } else {
          result.textContent = "❌ 오답!";
        }

        // ✅ 공부용 정답 공개(서버 응답 기반) - XSS 방지: textContent만 사용
        rvPron.textContent = data.answer_pron || "";
        rvJp.textContent = data.answer_jp || "";
        rvKo.textContent = data.answer_ko || "";
        reveal.style.display = "block";

      } catch(e){
        result.textContent = "오류가 발생했어요.";
      } finally{
        setBusy(false);
      }
    }

    checkBtn.addEventListener("click", submit);
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        submit();
      }
    });
  })();
</script>

<style>
  .dialog-wrap { max-width: 900px; margin: 0 auto; }
  .scene-img { width: 100%; border-radius: 14px; }
  .bubbles { margin-top: 16px; display: grid; gap: 12px; }
  .bubble { border: 1px solid #e5e7eb; border-radius: 14px; padding: 14px; background: #fff; }
  .partner .jp { font-size: 18px; font-weight: 800; }
  .partner .pron { margin-top: 6px; color: #555; }
  .me .answer-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin: 8px 0; }
  .check-btn { padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: #f7f7f7; cursor: pointer; }
  .result { margin-top: 10px; font-weight: 800; }
  .reveal { margin-top: 10px; color: #111; line-height:1.6; }
</style>

{% endblock %}
