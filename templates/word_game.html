{% extends "base.html" %}
{% block content %}

<style>
  .wg-wrap{
    max-width:1080px;
    margin:0 auto;
    padding:22px 18px 56px;
  }

  .wg-head{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:16px;
    margin-bottom:14px;
  }
  .wg-title{
    font-size:34px;
    font-weight:900;
    letter-spacing:-0.5px;
    margin:0;
  }
  .wg-sub{
    margin:6px 0 0;
    color:#6b7280;
    font-size:14px;
    line-height:1.45;
  }

  .wg-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:40px;
    padding:0 14px;
    border-radius:12px;
    border:1px solid rgba(15,23,42,0.10);
    background:#fff;
    text-decoration:none;
    color:#0f172a;
    font-weight:800;
    cursor:pointer;
  }
  .btn.primary{
    background:#2563eb;
    color:#fff;
    border-color:rgba(37,99,235,0.22);
  }
  .btn.ghost{
    background:#f8fafc;
  }

  .wg-panel{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin:14px 0 12px;
  }
  .wg-chip{
    display:flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:14px;
    background:#fff;
    border:1px solid rgba(15,23,42,0.10);
  }
  .wg-chip b{ font-weight:900; }
  .wg-chip .muted{ color:#64748b; font-size:12px; }

  .wg-box{
    background:#fff;
    border:1px solid rgba(15,23,42,0.10);
    border-radius:18px;
    box-shadow:0 10px 30px rgba(2,8,23,0.06);
    overflow:hidden;
  }

  .wg-arena{
    position:relative;
    height:420px;
    background: linear-gradient(180deg, #f8fbff, #f1f5ff);
    border-bottom:1px solid rgba(15,23,42,0.08);
  }

  .wg-line{
    position:absolute;
    top:0;
    right:0;
    width:10px;
    height:100%;
    background: rgba(239,68,68,0.20);
    border-left:2px solid rgba(239,68,68,0.55);
  }
  .wg-line::after{
    content:"GAME OVER LINE";
    position:absolute;
    top:10px;
    right:12px;
    font-size:11px;
    font-weight:900;
    color:rgba(239,68,68,0.75);
    letter-spacing:0.5px;
  }

  .wg-word{
    position:absolute;
    left:0;
    top:0;
    padding:10px 12px;
    border-radius:14px;
    background:#ffffffcc;
    border:1px solid rgba(37,99,235,0.18);
    box-shadow:0 10px 18px rgba(37,99,235,0.08);
    backdrop-filter: blur(6px);
    user-select:none;
    min-width:120px;
  }
  .wg-word .jp{
    font-size:12px;
    color:#64748b;
    font-weight:700;
    margin-bottom:2px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .wg-word .pron{
    font-size:18px;
    font-weight:900;
    color:#0f172a;
    white-space:nowrap;
  }
  .wg-word.hit{
    transform: scale(0.98);
    opacity:0.5;
  }

  .wg-bottom{
    display:flex;
    gap:10px;
    align-items:center;
    padding:12px;
    background:#fff;
  }

  .wg-input{
    flex:1;
    height:44px;
    border-radius:14px;
    border:1px solid rgba(15,23,42,0.12);
    padding:0 14px;
    font-size:15px;
    outline:none;
  }
  .wg-input:focus{
    border-color: rgba(37,99,235,0.40);
    box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
  }

  .wg-hint{
    padding:10px 12px 14px;
    color:#64748b;
    font-size:12px;
    line-height:1.5;
  }

  /* âœ… ì˜¤ë²„ë ˆì´ëŠ” í™”ë©´ ì¤‘ì•™ ê³ ì • + ë°”ê¹¥ ìŠ¤í¬ë¡¤ í—ˆìš© */
.wg-overlay{
  position:fixed;          /* ê¸°ì¡´ absoluteë©´ fixedë¡œ */
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;            /* ê°€ì¥ìë¦¬ ì—¬ë°± */
  background: rgba(2,6,23,0.35);
  backdrop-filter: blur(6px);
  z-index:9999;

  overflow:auto;           /* âœ… ì˜¤ë²„ë ˆì´ ìì²´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
}

/* âœ… ëª¨ë‹¬: ìµœëŒ€ ë†’ì´ ì œí•œ + ë‚´ë¶€ ìŠ¤í¬ë¡¤(ë“œë˜ê·¸) */
.wg-modal{
  width:min(900px, 96vw);
  max-height: min(78vh, 720px);
  background:#fff;
  border-radius:18px;
  border:1px solid rgba(15,23,42,0.10);
  box-shadow:0 20px 60px rgba(2,8,23,0.22);

  display:flex;            /* âœ… ë‚´ë¶€ë¥¼ header/body/footerë¡œ ë‚˜ëˆ„ê¸° */
  flex-direction:column;
  overflow:hidden;         /* footer ê³ ì • ìœ„í•´ hidden */
}

/* ëª¨ë‹¬ ìƒë‹¨(ì œëª©/ì„¤ëª…) ì˜ì—­ */
.wg-modal-head{
  padding:16px 16px 10px;
  border-bottom:1px solid rgba(15,23,42,0.06);
}
.wg-modal h3{ margin:0; font-size:20px; font-weight:900; letter-spacing:-0.3px; }
.wg-modal p{ margin:8px 0 0; color:#6b7280; font-size:13px; line-height:1.5; }

/* âœ… ëª¨ë‹¬ ë³¸ë¬¸: ì—¬ê¸°ë§Œ ìŠ¤í¬ë¡¤(ë“œë˜ê·¸) */
.wg-modal-body{
  padding:12px 16px 14px;
  overflow:auto;           /* âœ… ë“œë˜ê·¸/íœ  ìŠ¤í¬ë¡¤ */
  -webkit-overflow-scrolling: touch;
}

/* âœ… ëª¨ë“œ ì„ íƒ ì¤„: í•­ìƒ ë³´ì´ê²Œ */
.wg-row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}

/* âœ… ì¹´í…Œê³ ë¦¬: ê·¸ë¦¬ë“œ ìœ ì§€ + ë†’ì´ ìë™ */
#wgCats{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap:8px;
  margin-top:12px;
  align-items:stretch;
}

/* âœ… ëª¨ë‹¬ í•˜ë‹¨ ë²„íŠ¼: í•­ìƒ ì•„ë˜ ê³ ì • */
.wg-modal-foot{
  padding:12px 16px;
  border-top:1px solid rgba(15,23,42,0.06);
  background:#fff;
  display:flex;
  justify-content:flex-end;
  gap:10px;
}

/* âœ… ì‘ì€ í™”ë©´ ëŒ€ì‘ */
@media (max-width: 560px){
  #wgCats{ grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
  .wg-overlay{ padding:12px; }
}
.wg-intro{
  margin: 12px 0 14px;
  padding: 14px 16px;
  background:#fff;
  border:1px solid rgba(15,23,42,.08);
  border-radius:14px;
}

.wg-intro-title{
  font-size:14px;
  font-weight:900;
  margin:0 0 6px;
  color:#0f172a;
}

.wg-intro-desc{
  font-size:13px;
  line-height:1.6;
  color:#475569;
  margin:0 0 10px;
}

.wg-intro-list{
  margin:0;
  padding-left:16px;
  color:#475569;
  font-size:12.5px;
}

.wg-intro-list li{ margin:4px 0; }


</style>

<div class="wg-wrap">
  <div class="wg-head">
    <div>
      <h1 class="wg-title">ğŸ® ë‹¨ì–´ ê²Œì„</h1>
      <p class="wg-sub">
        í™”ë©´ì— ë‚˜íƒ€ë‚˜ëŠ” <b>ë°œìŒ</b>ì„ ë³´ê³ , ì•„ë˜ ì…ë ¥ì¹¸ì— <b>í•œêµ­ì–´ ëœ»</b>ì„ ì…ë ¥í•˜ì„¸ìš”.<br>
        ë‹¨ì–´ê°€ ì˜¤ë¥¸ìª½ <b>ë¹¨ê°„ ì„ </b>ì„ ë„˜ìœ¼ë©´ ê²Œì„ì˜¤ë²„!
      </p>
    </div>

    <div class="wg-actions">
      <a class="btn ghost" href="{{ url_for('quiz') }}">â† ê²Œì„ ì„ íƒ</a>
      <a class="btn" href="{{ url_for('word_game_ranking_page') }}">ë­í‚¹ ë³´ê¸°</a>
      <button class="btn" id="wgResetBtn" type="button">ì¬ì‹œì‘</button>
      <button class="btn primary" id="wgStartBtn" type="button">ë‹¨ì–´ ì„ íƒ</button>
    </div>
  </div>
 <div class="wg-intro">
    <div class="wg-intro-title">ê²Œì„ íŒ</div>
    <div class="wg-intro-desc">
      ì œí•œ ì‹œê°„ ì•ˆì— <b>ì¼ë³¸ì–´ ë°œìŒ â†’ í•œêµ­ì–´ ëœ»</b>ì„ ë¹ ë¥´ê²Œ ë– ì˜¬ë¦¬ëŠ” í›ˆë ¨ì´ì—ìš”.
      ëª¨ë¥´ë©´ ê³¼ê°íˆ ë„˜ê¸°ê³ , í‹€ë¦° ë‹¨ì–´ëŠ” ë‹¨ì–´ëª¨ìŒì—ì„œ ë³µìŠµí•˜ë©´ íš¨ê³¼ê°€ ì¢‹ì•„ìš”.
    </div>
    <ul class="wg-intro-list">
      <li>âœ” ëª¨ë¥´ë©´ ì˜¤ë˜ ê³ ë¯¼í•˜ì§€ ë§ê³  ë¹ ë¥´ê²Œ ë„˜ê¸°ê¸°</li>
      <li>âœ” ìì£¼ í‹€ë¦¬ëŠ” ë‹¨ì–´ëŠ” ë°˜ë³µí•´ì„œ ì™¸ìš°ê¸°</li>
      <li>âœ” í•˜ë£¨ 1~2íŒë§Œ í•´ë„ ê¸°ì–µ ìœ ì§€ì— ë„ì›€</li>
    </ul>
  </div>
  <div class="wg-panel">
    <div class="wg-chip"><b>ì ìˆ˜</b> <span id="wgScore">0</span></div>
    <div class="wg-chip"><b>ë‚¨ì€ í’€</b> <span id="wgPool">-</span></div>
  </div>

  <div class="wg-box">
  <div class="wg-arena" id="wgArena">
    <div class="wg-line" id="wgLine"></div>

    <div class="wg-overlay" id="wgOverlay">
      <div class="wg-modal">

        <!-- âœ… ìƒë‹¨(ê³ ì •) -->
        <div class="wg-modal-head">
          <h3>ë‹¨ì–´ ê²Œì„ ì„¤ì •</h3>
          <p>ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ë©´ ê·¸ ë²”ìœ„ì—ì„œ ë‹¨ì–´ê°€ ë‚˜ì™€ìš”. (ë¯¸ì„ íƒ ì‹œ ì „ì²´)</p>
        </div>

        <!-- âœ… ë³¸ë¬¸(ìŠ¤í¬ë¡¤/ë“œë˜ê·¸ ë˜ëŠ” ì˜ì—­) -->
        <div class="wg-modal-body">
          <div class="wg-row" style="margin-top:10px;">
            <label class="wg-select">
              <input type="radio" name="wgMode" value="practice" checked>
              <b>ì—°ìŠµ ëª¨ë“œ</b>
              <span style="color:#64748b;font-size:12px;">(ì¹´í…Œê³ ë¦¬ ì„ íƒ ê°€ëŠ¥ / í’€ ëë‚˜ë©´ í´ë¦¬ì–´)</span>
            </label>

            <label class="wg-select">
              <input type="radio" name="wgMode" value="rank">
              <b>ë­í‚¹ ëª¨ë“œ</b>
              <span style="color:#64748b;font-size:12px;">(ì „ì²´ ë‹¨ì–´ / ì ìˆ˜ ì €ì¥ / ë¬´í•œ)</span>
            </label>
          </div>

          <div id="wgCats"></div>
        </div>

        <!-- âœ… í•˜ë‹¨(ê³ ì •) -->
        <div class="wg-modal-foot">
          <button class="btn" id="wgOverlayClose" type="button">ë‹«ê¸°</button>
          <button class="btn primary" id="wgOverlayStart" type="button">ê²Œì„ ì‹œì‘</button>
        </div>

      </div>
    </div>
  </div>
</div>


    <div class="wg-bottom">
      <input class="wg-input" id="wgInput" type="text" placeholder="ì—¬ê¸°ì— í•œêµ­ì–´ ëœ»ì„ ì…ë ¥í•˜ê³  Enter!" autocomplete="off" />
      <button class="btn" id="wgSubmit" type="button">Enter</button>
    </div>

    <div class="wg-hint">
      íŒ) ì •ë‹µ ë¹„êµëŠ” <b>ì•ë’¤ ê³µë°± ì œê±°</b> í›„ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ë¡œ íŒë‹¨í•´ìš”. (ì˜ˆ: â€œí™”ì¥ì‹¤â€)<br>
      í•„ìš”í•˜ë©´ ëœ» ë°ì´í„°ë¥¼ ë” ìì—°ìŠ¤ëŸ½ê²Œ(ë™ì˜ì–´ ì²˜ë¦¬) í™•ì¥í•´ì¤„ ìˆ˜ë„ ìˆì–´ìš”.
    </div>
  </div>
</div>

<script>
(() => {
  const arena = document.getElementById("wgArena");
  const lineEl = document.getElementById("wgLine");
  const overlay = document.getElementById("wgOverlay");
  const catsWrap = document.getElementById("wgCats");

  const startBtn = document.getElementById("wgStartBtn");
  const resetBtn = document.getElementById("wgResetBtn");
  const overlayStart = document.getElementById("wgOverlayStart");
  const overlayClose = document.getElementById("wgOverlayClose");

  const input = document.getElementById("wgInput");
  const submitBtn = document.getElementById("wgSubmit");

  const scoreEl = document.getElementById("wgScore");
  const poolEl = document.getElementById("wgPool");

  const toast = (msg) => {
    if (typeof window.showToast === "function") window.showToast(msg);
    else alert(msg);
  };

  let allCats = [];       // {key,title,count}
  let currentCats = [];   // ë§ˆì§€ë§‰ìœ¼ë¡œ ì ìš©ëœ ì¹´í…Œê³ ë¦¬(ì¬ì‹œì‘ì— ì‚¬ìš©)
  let pool = [];          // {cat_key,cat_title,jp,pron,ko}
  let active = [];        // {el,x,y,speed,word}
  let rafId = null;
  let running = false;

  let score = 0;
  let cleared = 0;

  // âœ… ê³ ì • ì†ë„/ê³ ì • ìŠ¤í°
  const FIXED_SPEED = 15;     // px/sec (ì›í•˜ë©´ 28~40 ì‚¬ì´ë¡œ ì¡°ì ˆ)
  const FIXED_SPAWN = 1200;   // ms (ì›í•˜ë©´ 900~1500 ì‚¬ì´ë¡œ ì¡°ì ˆ)

  let spawnEvery = FIXED_SPAWN;
  let spawnTimer = null;

  let scoreSaved = false;

  function norm(s){ return String(s || "").trim(); }

  function normAnswer(s){
    let t = norm(s);
    t = t.replace(/\([^)]*\)/g, "");
    t = t.replace(/[,\s]/g, "");
    t = t.replace(/ì›/g, "");
    if (t === "ë§Œ") return "10000";
    if (t === "ë§Œì›") return "10000";

    let m = t.match(/^(\d+)ë§Œ$/);
    if (m){
      const n = parseInt(m[1], 10);
      if (!Number.isNaN(n)) return String(n * 10000);
    }

    m = t.match(/^(\d+)ë§Œì›$/);
    if (m){
      const n = parseInt(m[1], 10);
      if (!Number.isNaN(n)) return String(n * 10000);
    }

    return t;
  }

  function splitAnswers(s){
    let t = String(s || "");
    t = t.replace(/\([^)]*\)/g, "");
    t = t.replace(/ë˜ëŠ”|or/gi, "/");
    t = t.replace(/[Â·,|]/g, "/");
    return t.split("/").map(x => normAnswer(x)).filter(Boolean);
  }

  function isCorrectAnswer(userInput, answerRaw){
    const u = normAnswer(userInput);
    if (!u) return false;
    const candidates = splitAnswers(answerRaw);
    if (!candidates.length) return false;
    return candidates.includes(u);
  }

  function getMode(){
    const r = overlay.querySelector('input[name="wgMode"]:checked');
    return r ? r.value : "practice";
  }

  function toggleCatsUI(){
    const mode = getMode();
    catsWrap.style.display = (mode === "rank") ? "none" : "grid";
  }

  async function loadPool(selectedCats){
    const qs = new URLSearchParams();
    qs.set("n", "99999");
    if (selectedCats && selectedCats.length){
      qs.set("cats", selectedCats.join(","));
    }

    const res = await fetch("/api/game_words?" + qs.toString());
    const data = await res.json();
    if (!data || !data.ok) throw new Error("pool load failed");

    pool = Array.isArray(data.items) ? data.items : [];
    poolEl.textContent = String(pool.length);

    if (!allCats.length){
      const map = new Map();
      for (const it of pool){
        const k = it.cat_key;
        if (!map.has(k)) map.set(k, {key:k, title: it.cat_title || k, count:0});
        map.get(k).count += 1;
      }
      allCats = Array.from(map.values()).sort((a,b) => a.title.localeCompare(b.title, "ko"));
      renderCats(allCats);
    }
  }

  function renderCats(cats){
    catsWrap.innerHTML = "";
    for (const c of cats){
      const label = document.createElement("label");
      label.className = "wg-select";
      label.innerHTML =
        `<input type="checkbox" value="${c.key}">
         <b>${c.title}</b>
         <span style="color:#64748b;font-size:12px;">(${c.count})</span>`;
      catsWrap.appendChild(label);
    }
  }

  function getSelectedCats(){
    const checks = catsWrap.querySelectorAll("input[type=checkbox]:checked");
    return Array.from(checks).map(x => x.value);
  }

  function clearArenaWords(){
    for (const a of active){
      if (a.el && a.el.parentNode) a.el.parentNode.removeChild(a.el);
    }
    active = [];
  }

  function setHUD(){
    scoreEl.textContent = String(score);
    poolEl.textContent = String(pool.length);
  }

  async function submitRankScoreIfNeeded(){
    if (getMode() !== "rank") return;
    try{
      const res = await fetch("/api/word_game/submit_score", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({score})
      });
      if (res.status === 401) return toast("ë­í‚¹ ì €ì¥ì€ ë¡œê·¸ì¸ í›„ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const data = await res.json();
      if (data && data.ok){
        if (data.updated) toast(`ì‹ ê¸°ë¡! ${data.best}ì `);
        else toast(`ê¸°ë¡: ${data.best}ì  (ìµœê³ ê¸°ë¡ ìœ ì§€)`);
      }
    }catch(e){}
  }

  async function stopGameCommon(){
    running = false;
    if (spawnTimer) clearInterval(spawnTimer);
    spawnTimer = null;
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    input.blur();
    overlay.style.display = "flex";
  }

  async function gameOver(reason){
    if (scoreSaved) return;
    scoreSaved = true;
    await stopGameCommon();
    await submitRankScoreIfNeeded();
    toast(reason || `ê²Œì„ì˜¤ë²„! ì ìˆ˜: ${score}ì `);
  }

  async function gameClear(){
    await stopGameCommon();
    toast(`í´ë¦¬ì–´! ì ìˆ˜: ${score}ì  (ì´ ${cleared}ê°œ ì •ë‹µ)`);
  }

  function spawnWord(){
    if (!running) return;

    if (!pool.length){
      if (getMode() === "rank"){
        loadPool([]).catch(()=>{});
      }
      return;
    }

    const it = pool.pop();
    poolEl.textContent = String(pool.length);

    const el = document.createElement("div");
    el.className = "wg-word";
    el.innerHTML = `
      <div class="jp">${it.jp}</div>
      <div class="pron">${it.pron}</div>
    `;
    arena.appendChild(el);

    const arenaRect = arena.getBoundingClientRect();
    const maxY = Math.max(20, arenaRect.height - 80);
    const y = 18 + Math.random() * (maxY - 18);
    const x = - (120 + Math.random() * 100);

    active.push({
      el,
      x,
      y,
      speed: FIXED_SPEED + Math.random() * 2, // âœ… ê±°ì˜ ê³ ì •(ì•½ê°„ì˜ ìì—°ìŠ¤ëŸ¬ì›€ë§Œ)
      word: it
    });

    el.style.transform = `translate(${x}px, ${y}px)`;
  }

  function tick(){
    if (!running) return;

    const lineRect = lineEl.getBoundingClientRect();
    const lineLeft = lineRect.left;

    for (const a of active){
      a.x += (a.speed / 60);
      a.el.style.transform = `translate(${a.x}px, ${a.y}px)`;

      const r = a.el.getBoundingClientRect();
      if (r.right >= lineLeft){
        gameOver(`ê²Œì„ì˜¤ë²„! ì ìˆ˜: ${score}ì `);
        return;
      }
    }

    if (getMode() === "practice" && pool.length === 0 && active.length === 0){
      gameClear();
      return;
    }

    rafId = requestAnimationFrame(tick);
  }

  function tryHit(){
    if (!running) return;

    const v = norm(input.value);

    if (!v){
      input.value = "";
      input.focus();
      input.classList.add("shake");
      setTimeout(()=>input.classList.remove("shake"), 220);
      return;
    }

    const idx = active.findIndex(a => isCorrectAnswer(v, a.word.ko));
    if (idx === -1){
      input.value = "";
      input.focus();

      input.classList.add("shake");
      setTimeout(()=>input.classList.remove("shake"), 240);

      input.disabled = true;
      setTimeout(()=>{ input.disabled = false; input.focus(); }, 180);
      return;
    }

    const a = active[idx];
    a.el.classList.add("hit");

    score += 1;
    cleared += 1;
    setHUD();

    setTimeout(() => {
      if (a.el && a.el.parentNode) a.el.parentNode.removeChild(a.el);
    }, 90);

    active.splice(idx, 1);

    input.value = "";
    input.focus();

    spawnWord();
  }

  function startGame(){
    scoreSaved = false;

    clearArenaWords();
    score = 0;
    cleared = 0;

    spawnEvery = FIXED_SPAWN;

    setHUD();

    running = true;
    overlay.style.display = "none";
    input.focus();

    spawnWord();
    if (pool.length) spawnWord();

    if (spawnTimer) clearInterval(spawnTimer);
    spawnTimer = setInterval(spawnWord, spawnEvery);

    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(tick);
  }

  async function openOverlay(){
    overlay.style.display = "flex";
    if (!allCats.length){
      await loadPool([]);
    }
    toggleCatsUI();
  }

  async function applyCatsAndStart(){
    const mode = getMode();

    if (mode === "rank") {
      currentCats = [];
      await loadPool([]);
    } else {
      const selected = getSelectedCats();
      currentCats = selected.length ? selected : [];
      await loadPool(currentCats);
      if (!pool.length){
        toast("ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ì— ë‹¨ì–´ê°€ ì—†ì–´ìš”.");
        return;
      }
    }

    startGame();
  }

  startBtn.addEventListener("click", () => openOverlay().catch(()=>toast("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨")));

  resetBtn.addEventListener("click", async () => {
    try{
      const mode = getMode();
      if (mode === "rank") await loadPool([]);
      else await loadPool(currentCats);
      startGame();
    }catch(e){
      toast("ì¬ì‹œì‘ ì‹¤íŒ¨(ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨)");
    }
  });

  overlayStart.addEventListener("click", () => {
    applyCatsAndStart().catch(()=>toast("ê²Œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”."));
  });

  overlayClose.addEventListener("click", () => {
    overlay.style.display = "none";
  });

  overlay.addEventListener("change", (e) => {
    if (e.target && e.target.name === "wgMode") toggleCatsUI();
  });

  submitBtn.addEventListener("click", tryHit);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") tryHit();
  });

  openOverlay().catch(()=>{});
})();
</script>

{% endblock %}
