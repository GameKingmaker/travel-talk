{% extends "base.html" %}

{% set page_title = "ê¸€ì“°ê¸° | ì¼ë°˜ê²Œì‹œíŒ - ì¼ë³¸ ì—¬í–‰ íšŒí™” ê³µë¶€ë°©" %}
{% set page_desc  = "ì¼ë°˜ê²Œì‹œíŒ ê¸€ì“°ê¸° í˜ì´ì§€ì…ë‹ˆë‹¤." %}
{% set page_robots = "noindex,nofollow" %}

{% block content %}

<section class="page-head" style="display:flex; align-items:flex-end; justify-content:space-between; gap:16px;">
  <div>
    <h1>ê¸€ì“°ê¸°</h1>
    <p>ì œëª© Â· ë‚´ìš© Â· ì´ë¯¸ì§€(ì„ íƒ)ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
  </div>
  <a class="btn" href="{{ url_for('board') }}">ì·¨ì†Œ</a>
</section>

<div class="board-wrap" style="padding:18px;">
  <form method="POST" enctype="multipart/form-data">

    <div style="display:flex; flex-direction:column; gap:14px; max-width:820px;">

      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600;">ê¸€ ì œëª©</label>
        <input type="text" name="title" value="{{ (form.title if form else '') | e }}" required
               style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb;">
      </div>

      {% if user and is_admin(user) %}
        <div style="margin-top:-6px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff;">
          <label style="display:flex; gap:10px; align-items:center; font-weight:900;">
            <input type="checkbox" name="is_notice" value="1"
                   {% if form and form.get('is_notice') %}checked{% endif %}>
            ğŸ“Œ ê³µì§€ê¸€ë¡œ ë“±ë¡
          </label>
          <div style="margin-top:6px; font-size:12px; color:#667085;">
            ê´€ë¦¬ìë§Œ ê³µì§€ê¸€ ì‘ì„±ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>
      {% endif %}

      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600;">ê¸€ ë‚´ìš©</label>
        <textarea name="content" rows="10" required
                  style="width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb;">{{ (form.content if form else '') | e }}</textarea>
      </div>

      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600;">ê¸€ ì´ë¯¸ì§€(ì„ íƒ)</label>

<input id="imagesInput"
       type="file"
       name="images"
       accept=".png,.jpg,.jpeg,.gif,.webp"
       multiple>

<div style="margin-top:6px; color:#667085; font-size:13px;">
  png / jpg / jpeg / gif / webp ì—…ë¡œë“œ ê°€ëŠ¥ (ì—¬ëŸ¬ ì¥ ì„ íƒ ê°€ëŠ¥)
</div>

<!-- âœ… ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
<div id="imagesPreview" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;"></div>


      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:4px;">
        <a class="btn" href="{{ url_for('board') }}">ì·¨ì†Œ</a>
        <button class="btn btn-primary" type="submit">ë“±ë¡</button>
      </div>

    </div>
  </form>
</div>

<script>
  const input = document.getElementById("imagesInput");
  const preview = document.getElementById("imagesPreview");

  let dt = new DataTransfer();

  function syncInputFiles(){
    input.files = dt.files;
  }

  function fileKey(f){
    return `${f.name}_${f.size}_${f.lastModified}`;
  }

  function renderPreview(){
    preview.innerHTML = "";
    [...dt.files].forEach((file, idx) => {
      if(!file.type.startsWith("image/")) return;

      const item = document.createElement("div");
      item.style.width = "130px";
      item.style.height = "96px";
      item.style.borderRadius = "12px";
      item.style.overflow = "hidden";
      item.style.border = "1px solid #e5e7eb";
      item.style.boxShadow = "0 6px 14px rgba(2,8,23,.08)";
      item.style.background = "#fff";
      item.style.position = "relative";

      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "cover";
      img.onload = () => URL.revokeObjectURL(img.src);

      // âœ… X ì‚­ì œ ë²„íŠ¼
      const x = document.createElement("button");
      x.type = "button";
      x.textContent = "Ã—";
      x.title = "ì„ íƒ ì·¨ì†Œ";
      x.style.position = "absolute";
      x.style.top = "6px";
      x.style.right = "6px";
      x.style.width = "26px";
      x.style.height = "26px";
      x.style.borderRadius = "999px";
      x.style.border = "1px solid rgba(0,0,0,.15)";
      x.style.background = "rgba(255,255,255,.92)";
      x.style.cursor = "pointer";
      x.style.fontSize = "18px";
      x.style.lineHeight = "22px";
      x.style.fontWeight = "900";

      x.addEventListener("click", () => {
        const newDT = new DataTransfer();
        [...dt.files].forEach((f, i) => { if(i !== idx) newDT.items.add(f); });
        dt = newDT;
        syncInputFiles();
        renderPreview();
      });

      item.appendChild(img);
      item.appendChild(x);
      preview.appendChild(item);
    });
  }

  input.addEventListener("change", () => {
    // âœ… ì‚¬ìš©ìê°€ ì„ íƒí•œ íŒŒì¼ë“¤
    const picked = [...input.files];

    // âœ… ì¤‘ë³µ ë°©ì§€(ê°™ì€ íŒŒì¼ ì—¬ëŸ¬ë²ˆ ì¶”ê°€ ë°©ì§€)
    const existing = new Set([...dt.files].map(fileKey));
    picked.forEach(f => {
      if(!existing.has(fileKey(f))) dt.items.add(f);
    });

    syncInputFiles();
    renderPreview();

    // âš ï¸ ì—¬ê¸°ì„œ input.value="" ì ˆëŒ€ ë„£ì§€ ë§ˆì„¸ìš”.
    // ë„£ìœ¼ë©´ íŒŒì¼ ì„ íƒì´ ì§€ì›Œì ¸ì„œ "ì„ íƒëœ íŒŒì¼ ì—†ìŒ"ì´ ë  ìˆ˜ ìˆì–´ìš”.
  });
</script>



{% endblock %}
