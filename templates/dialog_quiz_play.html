{% extends "base.html" %}
{% block content %}

<style>
  .wrap{ max-width:920px; margin:0 auto; padding:22px 18px 60px; }

  .head{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:14px; }
  .title{ font-size:28px; font-weight:900; margin:0; letter-spacing:-.3px; }
  .sub{ margin:8px 0 0; color:#64748b; font-size:14px; }

  .card{
    background:#fff; border:1px solid rgba(15,23,42,.08);
    border-radius:18px; padding:16px;
    box-shadow:0 10px 24px rgba(15,23,42,.06);
  }

  /* image */
  .scene-wrap{ display:flex; justify-content:center; margin:10px 0 18px; }
  .quiz-image{
    width:40%;
    max-width:420px;
    min-width:260px;
    height:auto;
    border-radius:18px;
    box-shadow:0 10px 24px rgba(0,0,0,.10);
  }
  @media (max-width:900px){ .quiz-image{ width:85%; min-width:auto; } }

  /* dialog lines */
  .lines{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }
  .line{
    display:flex; gap:10px; align-items:flex-start;
    padding:10px 12px; border-radius:14px;
    background:#f8fafc; border:1px solid rgba(15,23,42,.06);
  }
  .role{ font-weight:900; color:#0f172a; width:52px; flex:0 0 auto; }
  .jp{ font-weight:800; }
  .pron{ color:#64748b; font-size:13px; margin-left:8px; font-weight:700; }

  /* choices */
  .choices{ margin-top:14px; display:grid; grid-template-columns:1fr; gap:10px; }
  .choice{
    width:100%;
    display:flex; justify-content:space-between; align-items:center;
    text-align:left;
    padding:14px 14px;
    border-radius:16px;
    border:1px solid rgba(15,23,42,.10);
    background:#ffffff;
    cursor:pointer;
    transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    font-size:14px;
    font-weight:800;
    color:#0f172a;
  }
  .choice:hover{
    transform: translateY(-1px);
    border-color: rgba(37,99,235,.25);
    box-shadow:0 8px 18px rgba(37,99,235,.10);
  }
  .choice:active{ transform: translateY(0px) scale(.99); }
  .choice .badge{
    font-size:12px; font-weight:900;
    padding:4px 10px; border-radius:999px;
    background:#f1f5ff; border:1px solid rgba(37,99,235,.18);
    color:#1d4ed8;
    white-space:nowrap;
  }

  /* states */
  .choice.selected{
    border-color: rgba(37,99,235,.40);
    box-shadow:0 10px 22px rgba(37,99,235,.12);
    background:#f8fbff;
  }
  .choice.correct{
    border-color: rgba(34,197,94,.45);
    background:#f0fdf4;
    box-shadow:0 10px 22px rgba(34,197,94,.12);
  }
  .choice.wrong{
    border-color: rgba(239,68,68,.45);
    background:#fef2f2;
    box-shadow:0 10px 22px rgba(239,68,68,.10);
  }
  .choice .mark{
    font-size:18px;
    font-weight:900;
    opacity:0;
    transform: scale(.85);
    transition: opacity .12s ease, transform .12s ease;
    margin-left:10px;
  }
  .choice.correct .mark,
  .choice.wrong .mark{
    opacity:1;
    transform: scale(1);
  }

  /* result box */
  .result{
    margin-top:14px;
    display:none;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(15,23,42,.10);
    background:#f8fafc;
  }
  .result.show{ display:block; }
  .result .row{ display:flex; gap:8px; align-items:flex-start; }
  .result .icon{ font-size:18px; font-weight:900; }
  .result.ok{ border-color: rgba(34,197,94,.35); background:#f0fdf4; }
  .result.no{ border-color: rgba(239,68,68,.35); background:#fef2f2; }
  .result .msg{ font-weight:900; }
  .result .small{ margin-top:6px; color:#475569; font-size:13px; line-height:1.5; font-weight:700; }

  /* translation block */
  .trans-title{ margin-top:10px; font-weight:900; color:#0f172a; }
  .trans-lines{ margin-top:6px; display:flex; flex-direction:column; gap:6px; }
  .trans-line{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(15,23,42,.06);
    background:#ffffff;
  }
  .trans-role{ font-weight:900; margin-right:6px; }
  .trans-ko{ color:#0f172a; font-weight:800; }
  .trans-jp{ color:#64748b; font-size:12px; margin-top:2px; font-weight:700; }

  /* footer buttons */
  .actions{ margin-top:14px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:10px 14px;
    border-radius:12px;
    border:1px solid rgba(15,23,42,.10);
    background:#fff;
    font-weight:900;
    cursor:pointer;
    text-decoration:none;
    color:#0f172a;
  }
  .btn.primary{
    background:#2563eb;
    color:#fff;
    border-color: rgba(37,99,235,.40);
  }
  .btn.primary:disabled{
    opacity:.55;
    cursor:not-allowed;
  }
</style>

<div class="wrap">
  <div class="head">
    <div>
      <h1 class="title">{{ quiz.title }}</h1>
      <p class="sub">ê·¸ë¦¼ê³¼ ëŒ€í™”ë¥¼ ë³´ê³ , ì§€ê¸ˆ ìƒí™©ì— ì•Œë§ì€ ë¬¸ì¥ì„ ê³¨ë¼ ë§í˜€ë³´ì„¸ìš”.</p>
    </div>
    <a class="btn" href="{{ url_for('quiz_dialog_list') }}">ëª©ë¡</a>
  </div>

  <div class="card">
    <div class="scene-wrap">
      <img class="quiz-image" src="{{ url_for('static', filename=quiz.image) }}" alt="scene">
    </div>

    <div class="lines">
      {% for line in quiz.lines %}
        <div class="line">
          <div class="role">{{ line.role }}</div>
          <div>
            <span class="jp">{{ line.jp }}</span>
            <span class="pron">{{ line.pron }}</span>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- choices -->
    <div class="choices" id="choices">
      {% for ch in quiz.choices %}
        {% set no = loop.index %}
        <button type="button" class="choice choiceBtn" data-choice="{{ no }}">
          <span>{{ no }}. {{ ch }}</span>
          <span class="badge">ì„ íƒ</span>
          <span class="mark">âœ”</span>
        </button>
      {% endfor %}
    </div>

    <!-- result -->
    <div class="result" id="resultBox">
      <div class="row">
        <div class="icon" id="resultIcon">âœ”</div>
        <div style="width:100%;">
          <div class="msg" id="resultMsg">ì •ë‹µ!</div>
          <div class="small" id="resultText"></div>

          <!-- ë²ˆì—­/í•´ì„¤ -->
          <div id="translationWrap" style="display:none;">
            <div class="trans-title">ğŸ“– ëŒ€í™” ë²ˆì—­</div>
            <div class="trans-lines">
              {% for line in quiz.lines %}
                <div class="trans-line">
                  <div><span class="trans-role">{{ line.role }}:</span> <span class="trans-ko">{{ line.ko or "" }}</span></div>
                  <div class="trans-jp">({{ line.jp }} / {{ line.pron }})</div>
                </div>
              {% endfor %}
            </div>

            <div class="trans-title" style="margin-top:12px;">ğŸ’¡ ì™œ ì´ê²Œ ì •ë‹µì¼ê¹Œìš”?</div>
            <div class="small" id="explainKo"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="checkBtn" class="btn primary" disabled>ì •ë‹µ í™•ì¸</button>

      {% if next_id %}
        <a id="nextBtn" class="btn" href="{{ url_for('dialog_quiz_play', quiz_id=next_id) }}" style="display:none;">
          ë‹¤ìŒ ë¬¸ì œ â†’
        </a>
      {% else %}
        <a id="nextBtn" class="btn" href="{{ url_for('quiz_dialog_list') }}" style="display:none;">
          ëª©ë¡ìœ¼ë¡œ â†’
        </a>
      {% endif %}
    </div>
  </div>
</div>

<script>
(() => {
  const quizId = {{ quiz.id }};
  const choiceBtns = Array.from(document.querySelectorAll(".choiceBtn"));
  const checkBtn = document.getElementById("checkBtn");

  const resultBox = document.getElementById("resultBox");
  const resultIcon = document.getElementById("resultIcon");
  const resultMsg = document.getElementById("resultMsg");
  const resultText = document.getElementById("resultText");
  const translationWrap = document.getElementById("translationWrap");
  const explainKoEl = document.getElementById("explainKo");
  const nextBtn = document.getElementById("nextBtn");

  let selected = null;
  let locked = false;

  function toast(msg){
    if (typeof window.showToast === "function") window.showToast(msg);
    else alert(msg);
  }

  // âœ… ì„ íƒ UI
  choiceBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      if (locked) return;

      selected = parseInt(btn.dataset.choice, 10);

      choiceBtns.forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");

      // âœ… ì„ íƒí•˜ë©´ ì •ë‹µí™•ì¸ ë²„íŠ¼ í™œì„±í™”
      checkBtn.disabled = false;
    });
  });

  // âœ… ê²°ê³¼ í‘œì‹œ
  function showResult(isCorrect, answerNo, correctText, explainKo){
    answerNo = parseInt(answerNo, 10);
    if (!Number.isFinite(answerNo) || answerNo <= 0){
      toast("ì •ë‹µ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”. (answerNo í™•ì¸)");
      locked = false;
      checkBtn.disabled = false;
      return;
    }

    // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™” + ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ
    choiceBtns.forEach(b => {
      const n = parseInt(b.dataset.choice, 10);
      b.classList.remove("correct", "wrong");

      if (n === answerNo) b.classList.add("correct");
      if (selected === n && !isCorrect) b.classList.add("wrong");
    });

    // ê²°ê³¼ ë°•ìŠ¤ í‘œì‹œ
    resultBox.classList.add("show");
    resultBox.classList.toggle("ok", !!isCorrect);
    resultBox.classList.toggle("no", !isCorrect);

    resultIcon.textContent = isCorrect ? "âœ…" : "âŒ";
    resultMsg.textContent = isCorrect ? "ì •ë‹µ!" : "ì˜¤ë‹µ!";
    resultText.textContent = `ì •ë‹µ: ${answerNo}. ${correctText || ""}`.trim();

    // ë²ˆì—­/í•´ì„¤ í‘œì‹œ
    if (translationWrap) translationWrap.style.display = "block";
    if (explainKoEl) explainKoEl.textContent = explainKo || "";

    // ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ
    if (nextBtn) nextBtn.style.display = "inline-flex";
  }

  // âœ… ì •ë‹µ í™•ì¸
  checkBtn.addEventListener("click", async () => {
    if (locked) return;
    if (selected == null) return toast("ë³´ê¸°ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

    locked = true;
    checkBtn.disabled = true;

    try{
      const res = await fetch("{{ url_for('quiz_dialog_check') }}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ quiz_id: quizId, selected })
      });

      const data = await res.json().catch(() => null);

      if (!res.ok || !data || !data.ok){
        locked = false;
        checkBtn.disabled = false;
        return toast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. (ì„œë²„ ì‘ë‹µ í™•ì¸)");
      }

      // âœ… ì„œë²„ ì‘ë‹µ í‚¤ëŠ” answer / correct_text ë¡œ ê³ ì •
      showResult(!!data.correct, data.answer, data.correct_text, data.explain_ko);

    }catch(e){
      locked = false;
      checkBtn.disabled = false;
      toast("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.");
    }
  });

  // ì´ˆê¸°: ì„ íƒ ì „ì—” ë¹„í™œì„±
  checkBtn.disabled = true;
})();
</script>


{% endblock %}
