{% extends "base.html" %}
{% block title %}JLPT N4 PART 2 시험 | 테스트{% endblock %}

{# ✅ JLPT 전용 CSS를 base.html 위에 추가 로드 #}
{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/jlpt.css') }}">
{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#f6f8fc; --card:#fff; --ink:#0f172a; --muted:#64748b;
    --primary:#2563eb; --primary-weak:#eaf1ff;
    --good:#16a34a; --good-bg:#ecfdf3;
    --bad:#dc2626; --bad-bg:#fff1f2;
    --line:#e5e7eb; --shadow:0 12px 28px rgba(15,23,42,.08);

    /* subtle accents */
    --focus: 0 0 0 3px rgba(37,99,235,.16);
  }
  body{ background:var(--bg); }

  .card{
    border:1px solid var(--line)!important;
    box-shadow:var(--shadow);
    border-radius:18px;
    background:var(--card);
    overflow:hidden;
  }
  .card .card-body{ padding:18px; }

  .q-text{ white-space:pre-line; color:var(--ink); line-height:1.85; }
  #questionText{ font-size:1.12rem; font-weight:900; letter-spacing:-0.2px; }
  .muted{ color:var(--muted); font-size:.95rem; line-height:1.65; }

  /* =========================
     Guide box (Part3/Part1 톤)
  ========================= */
  .guide-box{
    border:1px solid #dbeafe;
    background:linear-gradient(180deg, #f5f9ff 0%, #ffffff 75%);
    border-radius:18px;
    padding:14px 14px;
    margin-top:14px;
  }
  .guide-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .guide-title{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight:950;
    color:var(--ink);
    letter-spacing:-0.2px;
  }
  .guide-ic{
    width:22px; height:22px;
    border-radius:999px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:13px;
    font-weight:950;
    color:#0b1f4b;
    border:1px solid #dbeafe;
    background:#ffffff;
    box-shadow:0 8px 18px rgba(37,99,235,.10);
  }
  .guide-pill{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #dbeafe;
    background:#ffffff;
    font-weight:950;
    color:#0b1f4b;
    font-size:.82rem;
  }
  .guide-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }
  .guide-item{
    border:1px solid #e2e8f0;
    background:#ffffff;
    border-radius:14px;
    padding:12px 12px;
  }
  .guide-item .k{
    font-weight:950;
    color:var(--muted);
    font-size:.85rem;
    margin-bottom:6px;
  }
  .guide-item .v{
    color:var(--ink);
    font-weight:700;
    line-height:1.7;
    font-size:.95rem;
  }
  @media (max-width: 720px){
    .guide-grid{ grid-template-columns: 1fr; }
  }

  /* ✅ 문제 패널 */
  .panel{
    border:1px solid #dbeafe;
    background:linear-gradient(180deg, #f5f9ff 0%, #ffffff 70%);
    border-radius:16px;
    padding:16px 16px;
  }
  .panel-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid #dbeafe;
    background:#ffffff;
    font-weight:950;
    color:var(--ink);
    font-size:.85rem;
  }
  .chip .dot{
    width:10px; height:10px; border-radius:999px;
    background:rgba(37,99,235,.95);
    box-shadow:0 8px 18px rgba(37,99,235,.22);
  }
  .panel-note{
    font-size:.92rem;
    color:var(--muted);
    font-weight:750;
    white-space:pre-line;
  }

  /* ✅ 보기 헤더 */
  .choices-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    margin-top:14px;
    margin-bottom:10px;
  }
  .choices-head .left{
    font-weight:950;
    color:var(--ink);
  }

  /* choices */
  .choice-row{
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px 14px;
    margin-bottom:12px;
    background:#fff;
    transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .choice-row:hover{
    border-color:#cbd5e1;
    box-shadow:0 10px 22px rgba(15,23,42,.06);
    transform:translateY(-1px);
    background:#fbfdff;
  }
  .choice-label{
    cursor:pointer;
    font-size:1.03rem;
    font-weight:850;
    letter-spacing:-0.1px;
    color:var(--ink);
  }
  .choice-row input{ transform:translateY(2px) scale(1.05); }
  .choice-row.selected{
    border-color:rgba(37,99,235,.55);
    background:linear-gradient(180deg, var(--primary-weak), #ffffff);
    box-shadow: 0 10px 22px rgba(37,99,235,.10);
  }

  /* buttons */
  .btn{
    border-radius:12px !important;
    font-weight:900 !important;
    letter-spacing:-0.1px;
  }
  .btn-primary{
    background:var(--primary)!important;
    border-color:var(--primary)!important;
    box-shadow:0 10px 20px rgba(37,99,235,.18);
  }
  .btn-outline-secondary, .btn-outline-primary{ border-width:1px !important; }
  .btn:focus{ box-shadow:var(--focus) !important; }

  a.btn.btn-outline-secondary{
    color:var(--ink);
    border-color:#cbd5e1;
  }
  a.btn.btn-outline-secondary:hover{
    color:var(--ink);
    background:#f8fafc;
    border-color:#94a3b8;
  }

  /* progress */
  .progress{
    background:#eef2ff;
    border-radius:999px;
    overflow:hidden;
    border:1px solid #dde6ff;
  }
  .progress-bar{ background:var(--primary); }

  /* nav */
  .q-nav{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .q-dot{
    width:34px; height:34px; border-radius:999px; border:1px solid var(--line);
    background:#fff; color:var(--ink); font-weight:950;
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; user-select:none;
    transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .q-dot:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(15,23,42,.08); border-color:#cbd5e1; }
  .q-dot.active{ border-color:rgba(37,99,235,.7); box-shadow:0 0 0 3px rgba(37,99,235,.15); }
  .q-dot.done{ background:#dcfce7; border-color:#86efac; color:#14532d; }
  .q-dot.correct{ background:var(--good-bg); border-color:#86efac; color:#14532d; }
  .q-dot.wrong{ background:var(--bad-bg); border-color:#fca5a5; color:#7f1d1d; }

  /* ✅ pill */
  .q-pill{
    height:34px;
    padding:0 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    color:var(--ink);
    font-weight:950;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    user-select:none;
    transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
  }
  .q-pill:hover{ transform:translateY(-1px); box-shadow:0 10px 22px rgba(15,23,42,.08); border-color:#cbd5e1; }
  .q-pill.active{ border-color:rgba(37,99,235,.7); box-shadow:0 0 0 3px rgba(37,99,235,.15); background:var(--primary-weak); }
  .q-pill.done{ background:#dcfce7; border-color:#86efac; color:#14532d; }
  .q-pill.correct{ background:var(--good-bg); border-color:#86efac; color:#14532d; }
  .q-pill.wrong{ background:var(--bad-bg); border-color:#fca5a5; color:#7f1d1d; }

  /* review */
  .review-card{
    border:1px solid var(--line);
    border-radius:18px;
    background:#fff;
    padding:16px;
  }
  .review-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .badge{
    font-size:.78rem; font-weight:950; padding:6px 10px; border-radius:999px;
    border:1px solid #dbe7ff; background:#f1f5ff; color:#0b1f4b;
  }
  .badge.good{ background:var(--good-bg); border-color:#bbf7d0; color:#166534; }
  .badge.bad{ background:var(--bad-bg); border-color:#fecaca; color:#991b1b; }
  .divider{ height:1px; background:var(--line); margin:16px 0; }

  /* ✅ 내답/정답 박스 */
  .ans-grid{
    margin-top:12px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  .ans-card{
    border:1px solid #dbeafe;
    background:#f8fbff;
    border-radius:16px;
    padding:14px 14px;
  }
  .ans-card .k{
    font-size:.85rem;
    color:var(--muted);
    font-weight:950;
    margin-bottom:8px;
  }
  .ans-card .v{
    font-weight:950;
    color:var(--ink);
    white-space:pre-line;
    line-height:1.6;
  }
  .ans-card.me{ border-color:#e2e8f0; background:#fbfcfe; }
  .ans-card.ok{ border-color:#bbf7d0; background:#f6fff7; }

  .ko-box{
    margin-top:14px;
    padding:14px 14px;
    border-radius:18px;
    border:1px solid #bbf7d0;
    background:linear-gradient(180deg, #f6fff7 0%, #ffffff 100%);
  }
  .ko-box .t{
    font-weight:950;
    color:#14532d;
    margin-bottom:10px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .ko-box .t .sq{
    width:12px; height:12px; border-radius:3px;
    background:#22c55e;
    box-shadow:0 10px 20px rgba(34,197,94,.18);
  }
  .ko-box .line{ font-size:.98rem; line-height:1.85; color:#14532d; font-weight:750; white-space:pre-line; }

  /* ✅ group stem box */
  .stem-box{
    border:1px solid #dbeafe;
    background:linear-gradient(180deg, #f5f9ff 0%, #ffffff 75%);
    border-radius:16px;
    padding:14px 16px;
    margin-top:10px;
    margin-bottom:14px;
  }
  .stem-title{ font-weight:950; margin-bottom:8px; color:var(--ink); }
  .stem-body{ white-space:pre-line; line-height:1.9; color:var(--ink); font-weight:750; }

  /* ✅ group sub question */
  .subq{
    border:1px solid #e2e8f0;
    border-radius:16px;
    padding:14px 14px 4px;
    background:#fff;
    margin-bottom:12px;
  }
  .subq .no{
    font-weight:950;
    color:var(--ink);
    margin-bottom:10px;
    line-height:1.6;
  }

  /* score */
  .score-pill{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid #dbeafe;
    background:linear-gradient(180deg, #f4f8ff 0%, #ffffff 100%);
    font-weight:950;
    color:var(--ink);
  }

  @media (max-width: 720px){
    .card .card-body{ padding:14px; }
    .ans-grid{ grid-template-columns: 1fr; }
  }
</style>

<div class="container n5-wrap" style="max-width:980px;">
  <!-- TOP -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="n5-title" style="font-weight:950;">N4 실전 테스트 · PART 2 文法</div>
          <span class="badge">진행: <span id="posText">1</span> / <span id="totalText">{{ total_questions }}</span></span>
        </div>
      </div>

      <!-- ✅ 시험 안내문 (Part1/Part3 톤으로 통일) -->
      <div class="guide-box">
        <div class="guide-head">
          <div class="guide-title">
            <span class="guide-ic">i</span>
            <span>N4 PART 2 文法 시험 안내</span>
          </div>
          <span class="guide-pill">총 {{ total_questions }}문항</span>
        </div>

        <div class="guide-grid">
    <div class="guide-item">
      <div class="k">시험 방법</div>
      <div class="v">문항을 풀면서 <b>다음/이전</b>으로 이동하거나, 위의 <b>문항 번호</b>를 눌러 빠르게 이동할 수 있어요.</div>
    </div>
    <div class="guide-item">
      <div class="k">정답 제출</div>
      <div class="v">마지막에 <b>채점/정답해설보기</b>를 누르면 점수와 해설이 표시됩니다. (미선택 문항도 제출 가능)</div>
    </div>
    <div class="guide-item">
      <div class="k">정답 해설</div>
      <div class="v">채점 후에는 문항 번호가 <b>정답(초록)/오답(빨강)</b>으로 표시되고, 번호를 클릭하면 <b>해당 문항 해설</b>이 아래에 나와요.</div>
    </div>
    <div class="guide-item">
      <div class="k">표시 방식</div>
      <div class="v"><b>내 답:</b> 1) 보기텍스트 / <b>정답:</b> 2) 보기텍스트 처럼 <b>번호 + 내용</b>이 함께 표시됩니다.</div>
    </div>
        </div>
      </div>

      <div class="mt-3">
        <div class="muted" style="margin-bottom:8px;">문항 빠른 이동</div>
        <div id="qNav" class="q-nav"></div>
      </div>

      <div class="progress mt-3" style="height:10px;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%;"></div>
      </div>
    </div>
  </div>

  <!-- SOLVE -->
  <div class="card" id="solveCard">
    <div class="card-body">
      <div class="mb-3">
        <div class="fw-bold mb-2" style="font-size:1.05rem;">문제</div>

        <div class="panel">
          <div class="panel-head">
            <div class="chip"><span class="dot"></span>문제 <span id="qNoChip">#1</span></div>
            <div class="panel-note">※ 正しい答えを選んで「次へ」。最後に採点します。</div>
          </div>

          <!-- ✅ 그룹 지문 박스 -->
          <div id="groupStemBox" class="stem-box d-none">
            <div class="stem-title" id="groupStemTitle">21~25 (그룹 문제)</div>
            <div class="stem-body" id="groupStemText"></div>
          </div>

          <div id="questionText" class="q-text"></div>
        </div>
      </div>

      <div class="choices-head">
        <div class="left">보기</div>
        <div class="muted">클릭하면 선택됩니다</div>
      </div>

      <div id="choicesWrap" class="mb-2"></div>

      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-2">
        <div class="d-flex gap-2">
          <button id="prevBtn" class="btn btn-outline-secondary" type="button">← 이전</button>
          <button id="nextBtn" class="btn btn-primary" type="button">다음 →</button>
        </div>
        <div class="d-flex gap-2">
          <button id="gradeBtn" class="btn btn-outline-primary" type="button">채점/정답해설보기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULT -->
  <div id="resultCard" class="card mt-4 d-none">
    <div class="card-body">
      <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
        <div class="fw-bold" style="font-size:1.1rem;">결과</div>
        <div class="score-pill">
          <span>점수</span>
          <b id="scoreText">0 / 0 (0점)</b>
          <span class="muted" style="font-size:.9rem;">(총 {{ total_questions }}문항)</span>
        </div>
      </div>

      <div class="divider"></div>

      <div class="muted" style="margin-bottom:10px;">
        ✅ 정답(초록) / ❌ 오답(빨강) 표시됨. <b>문항(또는 21~25)을 클릭하면 해당 해설이 아래에 표시됩니다.</b>
      </div>

      <div id="reviewNav" class="q-nav"></div>

      <div class="divider"></div>

      <div id="reviewDetail" class="review-card"></div>

      <div class="d-flex gap-2 flex-wrap mt-3">
        <a class="btn btn-outline-secondary" href="{{ url_for('jlpt_n4_test') }}">홈으로</a>
        <button class="btn btn-outline-primary" type="button" onclick="location.reload()">다시 풀기</button>
      </div>
    </div>
  </div>
</div>

<script>
  const QUESTIONS = {{ (questions or [])|tojson|safe }};
  const PART = {{ part|default(2) }};

  // 0-based
  const GROUP_START_IDX = 20; // 21번
  const GROUP_END_IDX   = 24; // 25번

  let idx = 0; // 현재 화면 인덱스(일반은 그 문제, 그룹은 20로 고정)
  const total = QUESTIONS.length;
  const answers = new Array(total).fill(null);

  let LAST_REVIEW = null;

  const posText = document.getElementById("posText");
  const totalText = document.getElementById("totalText");
  const progressBar = document.getElementById("progressBar");
  const questionText = document.getElementById("questionText");
  const choicesWrap = document.getElementById("choicesWrap");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const gradeBtn = document.getElementById("gradeBtn");
  const qNoChip = document.getElementById("qNoChip");

  const qNav = document.getElementById("qNav");
  const resultCard = document.getElementById("resultCard");
  const scoreText = document.getElementById("scoreText");
  const reviewNav = document.getElementById("reviewNav");
  const reviewDetail = document.getElementById("reviewDetail");

  const groupStemBox  = document.getElementById("groupStemBox");
  const groupStemText = document.getElementById("groupStemText");

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function normalizeQuestion(q) {
    const text = q?.q ?? q?.question ?? "";
    const choices = Array.isArray(q?.choices) ? q.choices : [];
    const answer = Number.isInteger(q?.answer) ? q.answer : 0;
    return { ...q, q: text, choices, answer };
  }

  function isGroupAnsweredDone() {
    for (let i = GROUP_START_IDX; i <= GROUP_END_IDX; i++) {
      if (answers[i] === null) return false;
    }
    return true;
  }

  function groupReviewState() {
    if (!LAST_REVIEW || !Array.isArray(LAST_REVIEW.items)) return null;
    let allCorrect = true;
    for (let i = GROUP_START_IDX; i <= GROUP_END_IDX; i++) {
      const it = LAST_REVIEW.items[i];
      if (!it || !it.is_correct) allCorrect = false;
    }
    return allCorrect ? "correct" : "wrong";
  }

  function navDotClass(i){
    const cls = [];
    if (answers[i] !== null) cls.push("done");
    if (i === idx) cls.push("active");

    if (LAST_REVIEW && Array.isArray(LAST_REVIEW.items)) {
      const it = LAST_REVIEW.items[i];
      if (it) cls.push(it.is_correct ? "correct" : "wrong");
    }
    return cls.join(" ");
  }

  function renderNav() {
    qNav.innerHTML = "";

    // 1~20
    for (let i = 0; i < GROUP_START_IDX; i++) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "q-dot " + navDotClass(i);
      btn.textContent = String(i + 1);
      btn.addEventListener("click", () => {
        idx = i;
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      qNav.appendChild(btn);
    }

    // 21~25 pill
    const pill = document.createElement("button");
    pill.type = "button";
    const pillCls = [];
    if (isGroupAnsweredDone()) pillCls.push("done");
    if (idx >= GROUP_START_IDX) pillCls.push("active");
    if (LAST_REVIEW && Array.isArray(LAST_REVIEW.items)) {
      const st = groupReviewState();
      if (st) pillCls.push(st);
    }
    pill.className = "q-pill " + pillCls.join(" ");
    pill.textContent = "21~25";
    pill.addEventListener("click", () => {
      idx = GROUP_START_IDX;
      render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
    qNav.appendChild(pill);
  }

  function renderSingle(i) {
    groupStemBox.classList.add("d-none");
    groupStemBox.style.display = "none";
    groupStemText.textContent = "";

    const q = normalizeQuestion(QUESTIONS[i]);
    questionText.textContent = q.q || "(문제 텍스트가 없습니다)";
    choicesWrap.innerHTML = "";

    const picked = answers[i];

    q.choices.forEach((choice, ci) => {
      const row = document.createElement("div");
      row.className = "choice-row d-flex align-items-center gap-2";
      if (picked === ci) row.classList.add("selected");

      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = "choice";
      radio.value = String(ci);
      radio.checked = picked === ci;

      const label = document.createElement("div");
      label.className = "choice-label";
      label.textContent = `${ci + 1}. ${choice}`;

      row.addEventListener("click", () => {
        answers[i] = ci;
        render();
      });

      row.appendChild(radio);
      row.appendChild(label);
      choicesWrap.appendChild(row);
    });
  }

  function renderGroup() {
    const gq = QUESTIONS[GROUP_START_IDX] || {};
    const stem = gq?.group?.stem_jp || "";

    groupStemBox.classList.remove("d-none");
    groupStemBox.style.display = "";
    groupStemText.textContent = stem;

    questionText.textContent = ""; // 그룹에서는 단일 문제 텍스트 비움
    choicesWrap.innerHTML = "";

    for (let i = GROUP_START_IDX; i <= GROUP_END_IDX; i++) {
      const q = normalizeQuestion(QUESTIONS[i]);
      const sub = document.createElement("div");
      sub.className = "subq";

      const no = document.createElement("div");
      no.className = "no";
      no.textContent = q.q || `#${i+1}`;
      sub.appendChild(no);

      const picked = answers[i];

      q.choices.forEach((choice, ci) => {
        const row = document.createElement("div");
        row.className = "choice-row d-flex align-items-center gap-2";
        if (picked === ci) row.classList.add("selected");

        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "choice_" + i;
        radio.value = String(ci);
        radio.checked = picked === ci;

        const label = document.createElement("div");
        label.className = "choice-label";
        label.textContent = `${ci + 1}. ${choice}`;

        row.addEventListener("click", () => {
          answers[i] = ci;
          render();
        });

        row.appendChild(radio);
        row.appendChild(label);
        sub.appendChild(row);
      });

      choicesWrap.appendChild(sub);
    }
  }

  function render() {
    if (!total) {
      questionText.textContent = "문제가 없습니다. (데이터를 확인해주세요)";
      choicesWrap.innerHTML = "";
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      renderNav();
      return;
    }

    // 진행 표시
    if (idx >= GROUP_START_IDX) {
      posText.textContent = "21~25";
      qNoChip.textContent = "#21~25";
    } else {
      posText.textContent = String(idx + 1);
      qNoChip.textContent = `#${idx+1}`;
    }
    totalText.textContent = String(total);

    const progIndex = (idx >= GROUP_START_IDX) ? (GROUP_END_IDX + 1) : (idx + 1);
    progressBar.style.width = Math.round((progIndex / total) * 100) + "%";

    prevBtn.disabled = (idx === 0);
    nextBtn.disabled = (idx >= GROUP_START_IDX);

    if (idx < GROUP_START_IDX) {
      renderSingle(idx);
    } else {
      idx = GROUP_START_IDX;
      renderGroup();
    }

    renderNav();
  }

  function renderReviewNav() {
    reviewNav.innerHTML = "";
    const items = Array.isArray(LAST_REVIEW?.items) ? LAST_REVIEW.items : [];

    // 1~20
    for (let i = 0; i < GROUP_START_IDX; i++) {
      const it = items[i];
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "q-dot " + (it?.is_correct ? "correct" : "wrong");
      btn.textContent = String(i + 1);
      btn.addEventListener("click", () => {
        renderReviewDetail(i);
        window.scrollTo({ top: resultCard.offsetTop - 10, behavior: "smooth" });
      });
      reviewNav.appendChild(btn);
    }

    // 21~25 pill
    const pill = document.createElement("button");
    pill.type = "button";
    const st = groupReviewState();
    pill.className = "q-pill " + (st ? st : "");
    pill.textContent = "21~25";
    pill.addEventListener("click", () => {
      renderReviewDetail(GROUP_START_IDX);
      window.scrollTo({ top: resultCard.offsetTop - 10, behavior: "smooth" });
    });
    reviewNav.appendChild(pill);
  }

  function renderReviewDetail(i) {
    const items = Array.isArray(LAST_REVIEW?.items) ? LAST_REVIEW.items : [];
    const groupMeta = LAST_REVIEW?.group_meta?.P2_M3;

    // ✅ 그룹 해설(21~25)
    if (i >= GROUP_START_IDX) {
      const stemJP = groupMeta?.stem_jp || "";
      const stemKO = groupMeta?.stem_ko || "";

      let html = `
        <div class="review-head">
          <div style="font-weight:950; color:var(--ink);">21~25（グループ問題）解説</div>
          <span class="badge ${groupReviewState()==="correct" ? "good" : "bad"}">${groupReviewState()==="correct" ? "✅ 전체 정답" : "❌ 일부 오답"}</span>
        </div>
        <div class="divider"></div>

        <div class="stem-box">
          <div class="stem-title">[지문(JP)]</div>
          <div class="stem-body">${escapeHtml(stemJP)}</div>
          ${stemKO ? `<div class="divider"></div><div class="stem-title">[지문(KO)]</div><div class="stem-body">${escapeHtml(stemKO)}</div>` : ``}
        </div>
      `;

      for (let qi = GROUP_START_IDX; qi <= GROUP_END_IDX; qi++) {
        const it = items[qi];
        const q = normalizeQuestion(QUESTIONS[qi] || {});
        const user = (it?.user_index === null || it?.user_index === undefined) ? null : Number(it.user_index);
        const ans = Number(it?.answer_index ?? 0);

        const userText = (user === null)
          ? "미선택"
          : `${user + 1}) ${q.choices[user] ?? ""}`;

        const ansText = `${ans + 1}) ${q.choices[ans] ?? ""}`;

        const koChoices = Array.isArray(it?.choices_ko) ? it.choices_ko : [];
        const koChoicesText = koChoices.length ? koChoices.map((c, idx) => `${idx+1}. ${c}`).join("\n") : "";

        html += `
          <div class="review-card" style="margin-top:12px;">
            <div class="review-head">
              <div style="font-weight:950; color:var(--ink);">#${qi+1}번</div>
              <span class="badge ${it?.is_correct ? "good" : "bad"}">${it?.is_correct ? "✅ 정답" : "❌ 오답"}</span>
            </div>

            <div class="divider"></div>

            <div class="q-text"><b>[문제(JP)]</b>\n${escapeHtml(q.q || "")}</div>

            <div class="ans-grid">
              <div class="ans-card me">
                <div class="k">내 답</div>
                <div class="v">${escapeHtml(userText)}</div>
              </div>
              <div class="ans-card ok">
                <div class="k">정답</div>
                <div class="v">${escapeHtml(ansText)}</div>
              </div>
            </div>

            ${(it?.q_ko || koChoicesText || it?.explain_ko) ? `
              <div class="ko-box">
                <div class="t"><span class="sq"></span><span>해설(한국어)</span></div>
                ${it?.q_ko ? `<div class="line"><b>문제:</b>\n${escapeHtml(it.q_ko)}</div>` : ""}
                ${koChoicesText ? `<div class="line" style="margin-top:8px;"><b>보기:</b>\n${escapeHtml(koChoicesText)}</div>` : ""}
                ${it?.explain_ko ? `<div class="line" style="margin-top:8px;"><b>설명:</b>\n${escapeHtml(it.explain_ko)}</div>` : ""}
              </div>
            ` : `<div class="muted" style="margin-top:12px;">(한국어 해설 데이터가 없습니다)</div>`}
          </div>
        `;
      }

      reviewDetail.innerHTML = html;
      return;
    }

    // ✅ 일반 해설(1~20)
    const it = items[i];
    const q = normalizeQuestion(QUESTIONS[i] || {});
    if (!it) {
      reviewDetail.innerHTML = `<div class="muted">해설 데이터가 없습니다.</div>`;
      return;
    }

    const user = (it.user_index === null || it.user_index === undefined) ? null : Number(it.user_index);
    const ans = Number(it.answer_index ?? 0);

    const userText = (user === null)
      ? "미선택"
      : `${user + 1}) ${q.choices[user] ?? ""}`;

    const ansText  = `${ans + 1}) ${q.choices[ans] ?? ""}`;

    const koChoices = Array.isArray(it.choices_ko) ? it.choices_ko : [];
    const koChoicesText = koChoices.length ? koChoices.map((c, idx) => `${idx+1}. ${c}`).join("\n") : "";

    reviewDetail.innerHTML = `
      <div class="review-head">
        <div style="font-weight:950; color:var(--ink);">#${i+1}번 해설</div>
        <span class="badge ${it.is_correct ? "good" : "bad"}">${it.is_correct ? "✅ 정답" : "❌ 오답"}</span>
      </div>

      <div class="divider"></div>

      <div class="q-text"><b>[문제(JP)]</b>\n${escapeHtml(q.q || "")}</div>

      <div class="ans-grid">
        <div class="ans-card me">
          <div class="k">내 답</div>
          <div class="v">${escapeHtml(userText)}</div>
        </div>
        <div class="ans-card ok">
          <div class="k">정답</div>
          <div class="v">${escapeHtml(ansText)}</div>
        </div>
      </div>

      ${(it.q_ko || koChoicesText || it.explain_ko) ? `
        <div class="ko-box">
          <div class="t"><span class="sq"></span><span>해설(한국어)</span></div>
          ${it.q_ko ? `<div class="line"><b>문제:</b>\n${escapeHtml(it.q_ko)}</div>` : ""}
          ${koChoicesText ? `<div class="line" style="margin-top:8px;"><b>보기:</b>\n${escapeHtml(koChoicesText)}</div>` : ""}
          ${it.explain_ko ? `<div class="line" style="margin-top:8px;"><b>설명:</b>\n${escapeHtml(it.explain_ko)}</div>` : ""}
        </div>
      ` : `<div class="muted" style="margin-top:12px;">(한국어 해설 데이터가 없습니다)</div>`}
    `;
  }

  prevBtn.addEventListener("click", () => {
    if (idx >= GROUP_START_IDX) {
      idx = GROUP_START_IDX - 1; // 그룹에서 이전 = 20번
      render();
      return;
    }
    if (idx > 0) { idx--; render(); }
  });

  nextBtn.addEventListener("click", () => {
    if (idx < GROUP_START_IDX - 1) {
      idx++;
      render();
    }
  });

  gradeBtn.addEventListener("click", async () => {
    const res = await fetch(`/api/jlpt/n4/test/grade/${PART || 2}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answers })
    });

    const data = await res.json();
    LAST_REVIEW = data;

    scoreText.textContent = `${data.correct} / ${data.total} (${data.score}점)`;

    resultCard.classList.remove("d-none");
    renderNav();
    renderReviewNav();
    renderReviewDetail(0);

    window.scrollTo({ top: resultCard.offsetTop - 10, behavior: "smooth" });
  });

  render();
</script>
{% endblock %}
