{% extends "base.html" %}
{% block content %}

<div class="page-head">
  <h1 class="page-title">회원 가입</h1>
  <p class="page-sub">기본 정보를 입력해 계정을 생성하세요.</p>
</div>

<div class="form-wrap">
  <form class="form-table" method="post" action="{{ url_for('register') }}" id="register-form">
    <div class="form-row">
      <div class="form-label">
        <span class="label-text">아이디</span>
        <span class="label-check">✔</span>
      </div>
      <div class="form-field">
        <input class="input" id="reg-username" type="text" name="username" placeholder="예) kim123"
               required maxlength="20" autocomplete="username"
               value="{{ form.username }}">
        <div class="help">
          사용자 ID는 <b>3~20자</b> 사이의 <b>영문+숫자</b>로 이루어져야 하며 <b>영문으로 시작</b>되어야 합니다.
          <div class="help-warn">아이디 2개 이상 사용할 경우 모두 사용 중지됩니다.</div>
        </div>

        <div class="field-msg" id="msg-username"></div>
        {% if errors.get('username') %}
          <div class="field-msg bad">{{ errors.get('username') }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-label">
        <span class="label-text">비밀번호</span>
        <span class="label-check">✔</span>
      </div>
      <div class="form-field">
        <input class="input" id="reg-password" type="password" name="password" placeholder="8~16자"
               required minlength="8" maxlength="16" autocomplete="new-password">
        <div class="help">비밀번호는 <b>8~16자</b>로 입력해주세요.</div>

        <div class="field-msg" id="msg-password"></div>
        {% if errors.get('password') %}
          <div class="field-msg bad">{{ errors.get('password') }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-label">
        <span class="label-text">비밀번호 확인</span>
        <span class="label-check">✔</span>
      </div>
      <div class="form-field">
        <input class="input" id="reg-password2" type="password" name="password2" placeholder="비밀번호 재입력"
               required minlength="8" maxlength="16" autocomplete="new-password">

        <div class="field-msg" id="msg-password2"></div>
        {% if errors.get('password2') %}
          <div class="field-msg bad">{{ errors.get('password2') }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-label">
        <span class="label-text">닉네임</span>
        <span class="label-check">✔</span>
      </div>
      <div class="form-field">
        <input class="input" id="reg-nickname" type="text" name="nickname" placeholder="2~8자"
               required minlength="2" maxlength="8" autocomplete="nickname"
               value="{{ form.nickname }}">
        <div class="help">
          닉네임은 <b>2~8자</b> 이내여야 합니다.
          <ul class="help-list">
            <li>정치 관련, 특정 사이트 언급, 반사회적, 성적, 욕설 닉네임은 금지합니다.</li>
            <li>신상 정보 금지입니다.</li>
            <li>1달에 1번 닉네임 변경 가능합니다(추후 적용).</li>
          </ul>
        </div>

        <div class="field-msg" id="msg-nickname"></div>
        {% if errors.get('nickname') %}
          <div class="field-msg bad">{{ errors.get('nickname') }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-label">
        <span class="label-text">이메일 주소</span>
        <span class="label-check">✔</span>
      </div>
      <div class="form-field">
        <input class="input" id="reg-email" type="email" name="email" placeholder="예) example@naver.com"
               required autocomplete="email"
               value="{{ form.email }}">
        <div class="help">
          <b class="help-link">naver.com 메일 주소로만 가입 가능합니다.</b><br>
          메일주소는 메일인증 후 비밀번호 변경/찾기 등에 사용됩니다.<br>
          인증 메일이 보이지 않으면 스팸편지함을 열어보시길 바랍니다.
          <div class="help-note">※ 현재 개발 단계에서는 인증코드가 서버 콘솔(터미널)에 출력됩니다. (실서비스는 메일 발송 연동)</div>
        </div>

        <div class="field-msg" id="msg-email"></div>
        {% if errors.get('email') %}
          <div class="field-msg bad">{{ errors.get('email') }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-label">
        <span class="label-text">이메일 주소 확인</span>
        <span class="label-check">✔</span>
      </div>
      <div class="form-field">
        <input class="input" id="reg-email2" type="email" name="email2" placeholder="이메일 재입력"
               required autocomplete="email"
               value="{{ form.email2 }}">

        <div class="field-msg" id="msg-email2"></div>
        {% if errors.get('email2') %}
          <div class="field-msg bad">{{ errors.get('email2') }}</div>
        {% endif %}
      </div>
    </div>

    <div class="form-row">
      <div class="form-label">
        <span class="label-text">메일링 가입</span>
      </div>
      <div class="form-field">
        <label class="checkline">
          <input type="checkbox" name="mailing" value="1" checked>
          <span>메일링 가입이 체크되지 않으면 단체메일/공지 메일을 받지 않습니다. (추후 적용)</span>
        </label>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn primary" type="submit" id="registerBtn" disabled>등록</button>
      <a class="btn" href="{{ url_for('index') }}">취소</a>
    </div>
  </form>
</div>
<script>
(function(){
  const $ = (id) => document.getElementById(id);

  const elU  = $("reg-username");
  const elN  = $("reg-nickname");
  const elE  = $("reg-email");
  const elE2 = $("reg-email2");
  const elP  = $("reg-password");
  const elP2 = $("reg-password2");

  const msgU  = $("msg-username");
  const msgN  = $("msg-nickname");
  const msgE  = $("msg-email");
  const msgE2 = $("msg-email2");
  const msgP  = $("msg-password");
  const msgP2 = $("msg-password2");

  const btn = $("registerBtn");

  function refreshButton(){
    if (!btn) return;
    const ok =
      msgU.classList.contains("good") &&
      msgN.classList.contains("good") &&
      msgE.classList.contains("good") &&
      msgE2.classList.contains("good") &&
      msgP.classList.contains("good") &&
      msgP2.classList.contains("good");

    btn.disabled = !ok;
    btn.style.opacity = ok ? "1" : "0.5";
    btn.style.cursor  = ok ? "pointer" : "not-allowed";
  }

  function setMsg(el, ok, text){
    if (!el) return;
    el.textContent = text || "";
    el.classList.remove("good","bad");
    if (text){
      el.classList.add(ok ? "good" : "bad");
    }
    refreshButton();
  }

  function debounce(fn, ms){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  async function validateUsername(){
    const v = (elU.value || "").trim();
    if (!v){ setMsg(msgU, false, ""); return; }
    const res = await fetch(`/api/validate/username?u=${encodeURIComponent(v)}`);
    const data = await res.json();
    setMsg(msgU, !!data.ok && !!data.available, data.msg || "");
  }

  async function validateNickname(){
    const v = (elN.value || "").trim();
    if (!v){ setMsg(msgN, false, ""); return; }
    const res = await fetch(`/api/validate/nickname?n=${encodeURIComponent(v)}`);
    const data = await res.json();
    setMsg(msgN, !!data.ok && !!data.available, data.msg || "");
  }

  async function validateEmail(){
    const v = (elE.value || "").trim().toLowerCase();
    if (!v){ setMsg(msgE, false, ""); return; }
    const res = await fetch(`/api/validate/email?e=${encodeURIComponent(v)}`);
    const data = await res.json();
    setMsg(msgE, !!data.ok && !!data.available, data.msg || "");
  }

  function validateEmail2(){
    const a = (elE.value || "").trim().toLowerCase();
    const b = (elE2.value || "").trim().toLowerCase();
    if (!b){ setMsg(msgE2, false, ""); return; }
    if (a !== b) setMsg(msgE2, false, "이메일이 일치하지 않습니다.");
    else setMsg(msgE2, true, "이메일이 일치합니다.");
  }

  function validatePassword(){
    const v = elP.value || "";
    if (!v){ setMsg(msgP, false, ""); return; }
    if (v.length < 8 || v.length > 16) setMsg(msgP, false, "비밀번호는 8~16자여야 합니다.");
    else setMsg(msgP, true, "사용 가능한 비밀번호입니다.");
  }

  function validatePassword2(){
    const a = elP.value || "";
    const b = elP2.value || "";
    if (!b){ setMsg(msgP2, false, ""); return; }
    if (a !== b) setMsg(msgP2, false, "비밀번호가 일치하지 않습니다.");
    else setMsg(msgP2, true, "비밀번호가 일치합니다.");
  }

  const dUsername = debounce(validateUsername, 250);
  const dNickname = debounce(validateNickname, 250);
  const dEmail    = debounce(validateEmail, 250);

  if (elU) elU.addEventListener("input", dUsername);
  if (elN) elN.addEventListener("input", dNickname);
  if (elE) elE.addEventListener("input", () => { dEmail(); validateEmail2(); });
  if (elE2) elE2.addEventListener("input", validateEmail2);

  if (elP) elP.addEventListener("input", () => { validatePassword(); validatePassword2(); });
  if (elP2) elP2.addEventListener("input", validatePassword2);

  // ✅ 페이지 로드시 값이 이미 있으면 한번 검사(버튼 활성화까지)
  if (elU && elU.value) validateUsername();
  if (elN && elN.value) validateNickname();
  if (elE && elE.value) validateEmail();
  validateEmail2();
  validatePassword();
  validatePassword2();
  refreshButton();
})();
</script>


{% endblock %}
