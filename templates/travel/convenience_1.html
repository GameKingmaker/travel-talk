{# templates/travel/convenience_1.html #}
{% extends "base.html" %}

{% set page_title = "í¸ì˜ì  | ì¼ë³¸ ì—¬í–‰ ì‹œë®¬ë ˆì´ì…˜" %}
{% set page_desc = "í¸ì˜ì ì—ì„œ ì‡¼í•‘í•˜ê³  ê³„ì‚°í•˜ë©° ì¼ë³¸ì–´ë¥¼ í•™ìŠµí•˜ëŠ” ìƒí™©" %}
{% set page_robots = "noindex,nofollow" %}

{% block content %}
<style>
  .travel-wrap{ max-width:1080px; margin:0 auto; padding:22px 18px 48px; }
  .stage{
    position:relative; width:100%; aspect-ratio:16/9;
    border-radius:18px; overflow:hidden;
    box-shadow: 0 18px 40px rgba(2,8,23,.20);
    background:#0b1220;
  }
  .bg{
    position:absolute; inset:0;
    background: url("{{ url_for('static', filename='travel/bg/convenience.png') }}") center/cover no-repeat;
  }
  .char{
    position:absolute; left:50%; bottom:14%;
    transform: translateX(-50%);
    width: clamp(320px, 42%, 520px);
    max-height: 84%;
    object-fit: contain;
    pointer-events:none;
    filter: drop-shadow(0 18px 30px rgba(0,0,0,.35));
    z-index:4;
  }
  .hud{ position:absolute; left:16px; top:14px; display:flex; gap:10px; z-index:6; }
  .chip{
    background: rgba(255,255,255,.90);
    border: 1px solid rgba(226,232,240,.9);
    border-radius:999px;
    padding:8px 12px;
    font-weight:900; font-size:13px; color:#0f172a;
  }

  /* ìƒë‹¨ ì‡¼í•‘ íŒ¨ë„ */
  .panel{
    position:absolute; left:16px; right:16px; top:54px;
    display:grid; grid-template-columns: 1.2fr .8fr;
    gap:12px;
    z-index:6;
  }
  .card{
    background: rgba(255,255,255,.90);
    border: 1px solid rgba(226,232,240,.9);
    border-radius:16px;
    padding:12px;
    box-shadow: 0 10px 22px rgba(2,8,23,.12);
    overflow:hidden;
  }
  .card h3{
    margin:0 0 8px 0;
    font-size:14px; font-weight:1000; color:#0f172a;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
  }
  .sub{ font-size:12px; color:#334155; font-weight:800; opacity:.9; }

  .items{
  display:grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap:10px;

  /* âœ… ì¶”ê°€ */
  max-height: 300px;   /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì¡°ì ˆ */
  overflow: auto;
  padding-right: 4px;
}

  .item{
    border-radius:14px;
    padding:10px 10px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.75);
    cursor:pointer;
    transition: transform .08s ease, background .12s ease;
    user-select:none;
  }
  .item:hover{ transform: translateY(-1px); background: rgba(255,255,255,.95); }
  .jp{ font-weight:1000; font-size:14px; color:#0f172a; }
  .kana{ font-size:12px; color:#334155; font-weight:900; margin-top:2px; }
  .ko{ font-size:12px; color:#0f172a; opacity:.85; margin-top:2px; font-weight:900; }

  .cart{
    display:flex; flex-direction:column; gap:10px;
  }
  .cart-list{
    display:flex; flex-direction:column; gap:8px;
    max-height: 240px;
    overflow:auto;
    padding-right:4px;
  }
  .cart-row{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px;
    border-radius:14px;
    border:1px solid rgba(15,23,42,.10);
    background: rgba(255,255,255,.78);
  }
  .cart-left{ display:flex; flex-direction:column; gap:2px; }
  .qty{ font-size:12px; font-weight:1000; color:#0f172a; }
  .rm{
    background: rgba(15,23,42,.10);
    border:1px solid rgba(15,23,42,.12);
    border-radius:12px;
    padding:6px 10px;
    cursor:pointer;
    font-weight:1000;
  }
  .rm:hover{ background: rgba(15,23,42,.16); }

  .cart-actions{ display:flex; gap:8px; justify-content:flex-end; }
  .smallbtn{
    background: rgba(15,23,42,.08);
    border:1px solid rgba(15,23,42,.12);
    border-radius:12px;
    padding:8px 10px;
    cursor:pointer;
    font-weight:1000;
    color:#0f172a;
  }
  .smallbtn:hover{ background: rgba(15,23,42,.12); }

  /* í•˜ë‹¨ ëŒ€ì‚¬ ë°•ìŠ¤ */
  .box{
    position:absolute; left:0; right:0; bottom:0;
    padding:16px 18px 18px;
    background: rgba(54, 17, 92, .88);
    backdrop-filter: blur(6px);
    z-index:7; min-height: 170px;
  }
  .name{ font-weight:900; color:#fff; margin:0 0 8px 0; font-size:16px; }
  .line{ color:#fff; font-size:16px; line-height:1.55; white-space:pre-line; margin:0; }
  .right-hint{ position:absolute; right:18px; top:16px; color: rgba(255,255,255,.75); font-size:12px; font-weight:800; }

  .choices{ margin-top:12px; display:flex; flex-wrap:wrap; gap:10px; }
  .choice-btn{
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.22);
    color:#fff; border-radius:12px;
    padding:10px 12px; font-weight:900;
    cursor:pointer; transition: transform .08s ease, background .12s ease;
  }
  .choice-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.16); }

  .controls{ position:absolute; right:16px; bottom:16px; display:flex; gap:10px; }
  .navbtn{
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.22);
    color:#fff; border-radius:12px;
    padding:10px 14px; font-weight:900; cursor:pointer;
  }
  .navbtn:disabled{ opacity:.45; cursor:not-allowed; }

  /* ì²´í¬ì•„ì›ƒ ëª¨ë“œì—ì„œëŠ” ì‡¼í•‘ íŒ¨ë„ ìˆ¨ê¹€ */
  .hidden{ display:none !important; }

  /* ì‘ì€ ì•ˆë‚´ */
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    background: rgba(15,23,42,.06);
    border:1px solid rgba(15,23,42,.10);
    font-size:12px; font-weight:1000; color:#0f172a;
  }
  .worldmap-btn{
  position:absolute;
  top:14px;
  right:16px;
  z-index:20;
}

.worldmap-btn button{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:999px;
  background: rgba(255,255,255,.92);
  border:1px solid rgba(226,232,240,.95);
  box-shadow: 0 10px 18px rgba(2,8,23,.12);
  font-size:13px;
  font-weight:1000;
  color:#0f172a;
  cursor:pointer;
  transition: transform .1s ease, box-shadow .12s ease;
}

.worldmap-btn button:hover{
  transform: translateY(-1px);
  box-shadow: 0 14px 24px rgba(2,8,23,.18);
}

</style>

<div class="travel-wrap">
  <div class="stage" id="stage">
    <div class="bg"></div>
<!-- âœ… ì›”ë“œë§µ ë³µê·€ ë²„íŠ¼ -->
<div class="worldmap-btn">
  <button onclick="goWorldMap()">ğŸ—ºï¸ ì›”ë“œë§µìœ¼ë¡œ</button>
</div>

    <div class="hud">
      <div class="chip">í¸ì˜ì </div>
      <div class="chip" id="count">ì‡¼í•‘</div>
    </div>

    <img class="char" src="{{ url_for('static', filename='travel/char/convenience_staff.png') }}" alt="convenience_staff">

    <!-- âœ… ì‡¼í•‘ íŒ¨ë„(ë‹¨ì–´ í´ë¦­ â†’ ì¥ë°”êµ¬ë‹ˆ) : ì²˜ìŒì—” ìˆ¨ê¹€(ë°°ê²½ë§Œ ë³´ì´ê²Œ) -->
    <div class="panel hidden" id="shopPanel">
      <div class="card">
        <h3>
          í¸ì˜ì  ë‹¨ì–´(í´ë¦­í•˜ë©´ ë‹´ê¹€)
          <span class="pill">ì¼ë³¸ì–´ / ë°œìŒ / í•œêµ­ì–´</span>
        </h3>
        <div class="items" id="items"></div>
      </div>

      <div class="card cart">
        <h3>
          ë‚´ ì‡¼í•‘ë°”êµ¬ë‹ˆ
          <span class="sub" id="cartCount">0ê°œ</span>
        </h3>
        <div class="cart-list" id="cartList"></div>
        <div class="cart-actions">
          <button class="smallbtn" id="clearBtn">ë¹„ìš°ê¸°</button>
        </div>
      </div>
    </div>

    <!-- âœ… ëŒ€ì‚¬/ë¬¸ì œ ë°•ìŠ¤ -->
    <div class="box">
      <div class="right-hint" id="hint">í´ë¦­ ë˜ëŠ” ë‹¤ìŒ ë²„íŠ¼ìœ¼ë¡œ ì§„í–‰</div>
      <p class="name" id="speaker">ì§ì›</p>
      <p class="line" id="line"></p>

      <div class="choices" id="choices" style="display:none;"></div>

      <div class="controls">
        <button class="navbtn" id="prevBtn">ì´ì „</button>
        <button class="navbtn" id="nextBtn">ë‹¤ìŒ</button>
      </div>
    </div>
  </div>
</div>

<script>
  function fmt(jp, kana, ko){
    return `${jp}\n${kana}\n(${ko})`;
  }

  // âœ… í¸ì˜ì  ë‹¨ì–´ ë¦¬ìŠ¤íŠ¸(ì¤‘ë³µ ì—†ì´ ì´ 20ê°œ)
  // (ê¸°ì¡´ 9ê°œëŠ” ì œì™¸í•˜ê³ , ìƒˆë¡œ 20ê°œë¡œ êµ¬ì„±)
  const WORDS = [
    {id:"riceball", jp:"ãŠã«ãã‚Š", kana:"ì˜¤ë‹ˆê¸°ë¦¬", ko:"ì£¼ë¨¹ë°¥"},
    {id:"sandwich", jp:"ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ", kana:"ì‚°ë„ì´ì¹˜", ko:"ìƒŒë“œìœ„ì¹˜"},
    {id:"cupnoodle", jp:"ã‚«ãƒƒãƒ—éºº", kana:"ìº…í‘¸ë©˜", ko:"ì»µë¼ë©´"},
    {id:"ramen", jp:"ãƒ©ãƒ¼ãƒ¡ãƒ³", kana:"ë¼-ë©˜", ko:"ë¼ë©´"},
    {id:"chicken", jp:"ã‹ã‚‰ã‚ã’", kana:"ì¹´ë¼ì•„ê²Œ", ko:"ì¹˜í‚¨(ê°€ë¼ì•„ê²Œ)"},
    {id:"salad", jp:"ã‚µãƒ©ãƒ€", kana:"ì‚¬ë¼ë‹¤", ko:"ìƒëŸ¬ë“œ"},
    {id:"yogurt", jp:"ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ", kana:"ìš”-êµ¬ë£¨í† ", ko:"ìš”ê±°íŠ¸"},
    {id:"chocolate", jp:"ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ", kana:"ì´ˆì½”ë ˆ-í† ", ko:"ì´ˆì½œë¦¿"},
    {id:"bento", jp:"å¼å½“", kana:"ë²¤í† -", ko:"ë„ì‹œë½" },
    {id:"bread", jp:"ãƒ‘ãƒ³", kana:"íŒ¡", ko:"ë¹µ" },
    {id:"water", jp:"æ°´", kana:"ë¯¸ì¦ˆ", ko:"ë¬¼" },
    {id:"juice", jp:"ã‚¸ãƒ¥ãƒ¼ã‚¹", kana:"ì¥¬-ìŠ¤", ko:"ì£¼ìŠ¤" },
    {id:"coffee", jp:"ã‚³ãƒ¼ãƒ’ãƒ¼", kana:"ì½”-íˆ-", ko:"ì»¤í”¼" },
    {id:"snack", jp:"ãŠè“å­", kana:"ì˜¤ì¹´ì‹œ", ko:"ê³¼ì" },
    {id:"icecream", jp:"ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ", kana:"ì•„ì´ìŠ¤ì¿ ë¦¬-ë¬´", ko:"ì•„ì´ìŠ¤í¬ë¦¼" },
    {id:"magazine", jp:"é›‘èªŒ", kana:"ì-ì‹œ", ko:"ì¡ì§€ì±…" },
    {id:"gum", jp:"ã‚¬ãƒ ", kana:"ê°€ë¬´", ko:"ê»Œ"},
    {id:"candy", jp:"é£´", kana:"ì•„ë©”", ko:"ì‚¬íƒ•"},
    {id:"chips", jp:"ãƒãƒ†ãƒˆãƒãƒƒãƒ—ã‚¹", kana:"í¬í…Œí†  ì¹«í‘¸ìŠ¤", ko:"ê°ìì¹©"},
    {id:"tissue", jp:"ãƒ†ã‚£ãƒƒã‚·ãƒ¥", kana:"íŒƒìŠˆ", ko:"í‹°ìŠˆ"},
    {id:"umbrella", jp:"å‚˜", kana:"ì¹´ì‚¬", ko:"ìš°ì‚°"},
    {id:"battery", jp:"é›»æ± ", kana:"ë´ì¹˜", ko:"ê±´ì „ì§€"},
    {id:"charger", jp:"å……é›»å™¨", kana:"ì¥¬-ë´í‚¤", ko:"ì¶©ì „ê¸°"},
    {id:"mask", jp:"ãƒã‚¹ã‚¯", kana:"ë§ˆìŠ¤ì¿ ", ko:"ë§ˆìŠ¤í¬"},
    {id:"medicine", jp:"è–¬", kana:"ì¿ ìŠ¤ë¦¬", ko:"ì•½"},
    {id:"shampoo", jp:"ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼", kana:"ìƒ´í‘¸-", ko:"ìƒ´í‘¸"},
    {id:"toothpaste", jp:"æ­¯ã¿ãŒãç²‰", kana:"í•˜ë¯¸ê°€í‚¤ì½”", ko:"ì¹˜ì•½"},
    {id:"socks", jp:"é´ä¸‹", kana:"ì¿ ì¸ ì‹œíƒ€", ko:"ì–‘ë§"},
  ];
  

  const cart = new Map(); // id -> qty

  const elItems = document.getElementById("items");
  const elCartList = document.getElementById("cartList");
  const elCartCount = document.getElementById("cartCount");
  const elClear = document.getElementById("clearBtn");

  function renderItems(){
    elItems.innerHTML = "";
    WORDS.forEach(w=>{
      const d = document.createElement("div");
      d.className = "item";
      d.innerHTML = `
        <div class="jp">${w.jp}</div>
        <div class="kana">${w.kana}</div>
        <div class="ko">${w.ko}</div>
      `;
      d.onclick = (e)=>{
        e.stopPropagation();
        cart.set(w.id, (cart.get(w.id) || 0) + 1);
        renderCart();
      };
      elItems.appendChild(d);
    });
  }

  function renderCart(){
    elCartList.innerHTML = "";
    let total = 0;

    WORDS.forEach(w=>{
      const qty = cart.get(w.id) || 0;
      if(qty <= 0) return;
      total += qty;

      const row = document.createElement("div");
      row.className = "cart-row";
      row.innerHTML = `
        <div class="cart-left">
          <div class="jp">${w.jp} <span class="qty">x${qty}</span></div>
          <div class="kana">${w.kana}</div>
          <div class="ko">${w.ko}</div>
        </div>
        <button class="rm">ë¹¼ê¸°</button>
      `;
      row.querySelector(".rm").onclick = (e)=>{
        e.stopPropagation();
        const cur = cart.get(w.id) || 0;
        if(cur <= 1) cart.delete(w.id);
        else cart.set(w.id, cur - 1);
        renderCart();
      };
      elCartList.appendChild(row);
    });

    elCartCount.textContent = `${total}ê°œ`;
  }

  elClear.onclick = (e)=>{
    e.stopPropagation();
    cart.clear();
    renderCart();
  };

  renderItems();
  renderCart();

  // --------------------------
  // âœ… ëŒ€ì‚¬/ë¬¸ì œ ì§„í–‰
  // idx=0: ì–´ì„œì˜¤ì„¸ìš”(íŒ¨ë„ ìˆ¨ê¹€)
  // idx=1~2: ì‡¼í•‘(íŒ¨ë„ ë³´ì„)
  // idx>=3: ì²´í¬ì•„ì›ƒ(íŒ¨ë„ ìˆ¨ê¹€)
  // --------------------------
  const shopPanel = document.getElementById("shopPanel");

  const SCRIPT = [
    { type:"line", speaker:"ì§ì›",
      jp:"ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ï¼",
      kana:"ì´ë¼ìƒ¤ì´ë§ˆì„¸!",
      ko:"ì–´ì„œ ì˜¤ì„¸ìš”!"
    },
    { type:"line", speaker:"ë‚´ë ˆì´ì…˜",
      jp:"ä¸Šã®å˜èªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚«ã‚´ã«å…¥ã‚Šã¾ã™ã€‚é¸ã³çµ‚ã‚ã£ãŸã‚‰ã€Œæ¬¡ã¸ã€ã§ãŠä¼šè¨ˆã¸ã€‚",
      kana:"ìš°ì—ë…¸ íƒ„ê³ ì˜¤ ì¿ ë¦­ì¿ ìŠ¤ë£¨í†  ì¹´ê³ ë‹ˆ í•˜ì´ë¦¬ë§ˆìŠ¤. ì—ë¼ë¹„ì˜¤ì™€íƒ€ë¼ 'ì¸ ê¸°'ë° ì˜¤ì¹´ì´ì¼€-ì—.",
      ko:"ìœ„ ë‹¨ì–´ë¥¼ í´ë¦­í•˜ë©´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¨. ë‹¤ ê³¨ëìœ¼ë©´ 'ë‹¤ìŒ'ì„ ëˆŒëŸ¬ ê³„ì‚°ìœ¼ë¡œ ê°€ì."
    },

    // âœ… ì²´í¬ì•„ì›ƒ ì¥ë©´ ì‹œì‘
    { type:"line", speaker:"ë‚´ë ˆì´ì…˜",
      jp:"ãƒ¬ã‚¸ã«ä¸¦ã³ã¾ã—ãŸã€‚",
      kana:"ë ˆì§€ë‹ˆ ë‚˜ë¼ë¹„ë§ˆì‹œíƒ€.",
      ko:"ê³„ì‚°ëŒ€ì— ì¤„ì„ ì„°ìŠµë‹ˆë‹¤."
    },
    { type:"line", speaker:"ì§ì›",
      jp:"è¢‹ã«ãŠå…¥ã‚Œã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
      kana:"í›„ì¿ ë¡œë‹ˆ ì˜¤ì´ë ˆ ì‹œë§ˆì‡¼-ì¹´?",
      ko:"ë´‰íˆ¬ì— ë‹´ì•„ë“œë¦´ê¹Œìš”?"
    },
    { type:"choice", speaker:"ë‚˜",
      question_ko:"(ë¬¸ì œ) â€œë„¤, ë´‰íˆ¬ì— ë‹´ì•„ì£¼ì„¸ìš”â€ë¥¼ ê°€ì¥ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•˜ë©´?",
      choices:[
        { jp:"ã¯ã„ã€è¢‹ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚",
          kana:"í•˜ì´, í›„ì¿ ë¡œë‹ˆ ì´ë ˆí…Œ ì¿ ë‹¤ì‚¬ì´.",
          ko:"ë„¤, ë´‰íˆ¬ì— ë‹´ì•„ì£¼ì„¸ìš”.",
          correct:true
        },
        { jp:"ã¯ã„ã€ã“ã“ã§é£Ÿã¹ã¾ã™ã€‚",
          kana:"í•˜ì´, ì½”ì½”ë° íƒ€ë² ë§ˆìŠ¤.",
          ko:"ë„¤, ë¨¹ê³  ê°ˆê²Œìš”.",
          correct:false
        },
        { jp:"ã¯ã„ã€ãŠé‡£ã‚Šã‚’ãã ã•ã„ã€‚",
          kana:"í•˜ì´, ì˜¤ì¸ ë¦¬ì˜¤ ì¿ ë‹¤ì‚¬ì´.",
          ko:"ë„¤, ê±°ìŠ¤ë¦„ëˆ ì£¼ì„¸ìš”.",
          correct:false
        },
      ]
    },
    { type:"line", speaker:"ì§ì›",
      jp:"ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã“ã¡ã‚‰ãŒãƒ¬ã‚·ãƒ¼ãƒˆã§ã™ã€‚",
      kana:"ì•„ë¦¬ê°€í† - ê³ ìì´ë§ˆìŠ¤. ì½”ì¹˜ë¼ê°€ ë ˆì‹œ-í†  ë°ìŠ¤.",
      ko:"ê°ì‚¬í•©ë‹ˆë‹¤. ì˜ìˆ˜ì¦ ì—¬ê¸° ìˆìŠµë‹ˆë‹¤."
    },
    { type:"line", speaker:"ë‚´ë ˆì´ì…˜",
      jp:"è²·ã„ç‰©ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚æ¬¡ã¯ã©ã“ã¸è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿ",
      kana:"ì¹´ì´ëª¨ë…¸ê°€ ì˜¤ì™€ë¦¬ë§ˆì‹œíƒ€. ì¸ ê¸°ì™€ ë„ì½”ì— ì‡í…Œë¯¸ë§ˆì‡¼-ì¹´?",
      ko:"ì¥ë³´ê¸°ê°€ ëë‚¬ë‹¤. ë‹¤ìŒì€ ì–´ë””ë¡œ ê°€ë³¼ê¹Œ?",
      goto:"/travel/worldmap?current=convenience"
    },
  ];

  let idx = 0;
  let locked = false;

  const elSpeaker = document.getElementById("speaker");
  const elLine = document.getElementById("line");
  const elChoices = document.getElementById("choices");
  const elPrev = document.getElementById("prevBtn");
  const elNext = document.getElementById("nextBtn");
  const stage = document.getElementById("stage");

  function setShopVisible(on){
    shopPanel.classList.toggle("hidden", !on);
  }

  function setMode(){
    // idx=0: íŒ¨ë„ ìˆ¨ê¹€
    // idx=1~2: ì‡¼í•‘ íŒ¨ë„ í‘œì‹œ
    // idx>=3: ì²´í¬ì•„ì›ƒì´ë¯€ë¡œ ìˆ¨ê¹€
    const showShop = (idx >= 1 && idx <= 2);
    setShopVisible(showShop);

    const isCheckout = (idx >= 3);
    document.getElementById("count").textContent = isCheckout ? "ê³„ì‚°" : "ì‡¼í•‘";
  }

  function render(){
    const step = SCRIPT[idx];
    if(!step) return;

    setMode();

    // ì´ì „ ë²„íŠ¼
    elPrev.disabled = (idx <= 0) || locked;

    // choices reset
    elChoices.style.display = "none";
    elChoices.innerHTML = "";
    elNext.disabled = locked;

    if(step.type === "line"){
      elSpeaker.textContent = step.speaker || "";
      elLine.textContent = fmt(step.jp || "", step.kana || "", step.ko || "");
      elNext.disabled = false;
      return;
    }

    if(step.type === "choice"){
      elSpeaker.textContent = step.speaker || "";
      elLine.textContent = step.question_ko || "ì„ íƒì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.";
      locked = true;
      elNext.disabled = true;

      elChoices.style.display = "flex";
      step.choices.forEach((c)=>{
        const b = document.createElement("button");
        b.className = "choice-btn";
        b.textContent = `${c.jp}  /  ${c.kana}`;
        b.onclick = (e)=>{
          e.stopPropagation();
          elLine.textContent = `${c.jp}\n${c.kana}\n(${c.ko})`;

          if(c.correct){
            locked = false;
            elNext.disabled = false;
            elPrev.disabled = (idx <= 0);
            elChoices.style.display = "none";
          }else{
            elChoices.innerHTML = "";
            const retry = document.createElement("button");
            retry.className = "choice-btn";
            retry.textContent = "ë‹¤ì‹œ ì„ íƒí•˜ê¸°";
            retry.onclick = (ev)=>{
              ev.stopPropagation();
              locked = true;
              render();
            };
            elChoices.appendChild(retry);
          }
        };
        elChoices.appendChild(b);
      });
    }
  }

  function goPrev(){
    if(idx > 0){
      idx--;
      locked = false;
      render();
    }
  }

  function goNext(){
    const step = SCRIPT[idx];
    if(step && step.goto){
      window.location.href = step.goto;
      return;
    }
    if(idx < SCRIPT.length - 1){
      idx++;
      render();
    }
  }

  elNext.addEventListener("click", (e)=>{ e.stopPropagation(); if(!locked) goNext(); });
  elPrev.addEventListener("click", (e)=>{ e.stopPropagation(); if(!locked) goPrev(); });
  stage.addEventListener("click", ()=>{ if(!locked) goNext(); });

  render();
  function goWorldMap(){
  // í˜„ì¬ ì”¬ idë¥¼ worldmapì— ì „ë‹¬
  // ì˜ˆ: department, convenience, hospital ë“±
  const CURRENT_PLACE = "{{ current_place|default('convenience') }}";
  window.location.href = `/travel/worldmap?current=${CURRENT_PLACE}`;
}

</script>
{% endblock %}
