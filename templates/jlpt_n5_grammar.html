{% extends "base.html" %}

{% block title %}JLPT N5 ë¬¸ë²• | ê³ ê¸‰ ë¬¸ë²• ì •ë¦¬{% endblock %}

{# âœ… JLPT ì „ìš© CSSë¥¼ base.html ìœ„ì— ì¶”ê°€ ë¡œë“œ #}
{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/jlpt.css') }}">
{% endblock %}

{% block content %}

<!-- âœ… ìƒë‹¨ ì†Œê°œ -->
<div class="jlpt-card jlpt-intro">
  <h2 class="jlpt-intro-title">ğŸ“Œ JLPT N5 ë¬¸ë²•</h2>
  <p class="jlpt-intro-desc">
    N5 ë¬¸ë²•ì€ <b>ì¡°ì‚¬</b>, <b>ì •ì¤‘ì²´(ã§ã™/ã¾ã™)</b>, <b>ë¶€ì •/ê³¼ê±°</b>, <b>ã¦í˜•</b>, <b>í¬ë§/ëŠ¥ë ¥</b>ì²˜ëŸ¼
    â€œë¬¸ì¥ì„ ë§Œë“œëŠ” í‹€â€ì„ ìµíˆëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤. <br>
    ì•„ë˜ ë¶„ë¥˜ë¥¼ ëˆŒëŸ¬ì„œ í•„ìš”í•œ ë¬¸ë²•ë§Œ ê³¨ë¼ ë°˜ë³µí•˜ì„¸ìš”.
  </p>

  <ul class="jlpt-intro-list">
    <li><b>ì¶”ì²œ ë£¨í‹´</b>: ì˜¤ëŠ˜ 1ë¶„ â†’ ë¬¸ë²• 2~3ê°œ â†’ ì˜ˆë¬¸ ë“£ê¸° â†’ ë³€í˜• 2ê°œ ë§í•´ë³´ê¸°</li>
    <li><b>Tip</b>: ì˜ˆë¬¸ì„ ê·¸ëƒ¥ ì™¸ìš°ê¸°ë³´ë‹¤, <b>ìƒí™©/ë¶„í•´/ë³€í˜•</b>ì„ í•¨ê»˜ ë³´ë©´ â€œë¬¸ì¥ ë§Œë“¤ê¸°â€ê°€ ë©ë‹ˆë‹¤.</li>
  </ul>

  <p class="jlpt-intro-tip">â€» ë°œìŒ ë“£ê¸°ëŠ” ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¼ë³¸ì–´ ìŒì„±ìœ¼ë¡œ ì¬ìƒë©ë‹ˆë‹¤.</p>
  <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
    <a class="btn btn-outline" href="{{ url_for('jlpt_n5_home') }}">â† N5 í™ˆìœ¼ë¡œ</a>
  </div>
</div>

<!-- âœ… ë¶„ë¥˜(ì¹©) : ì¶”ì²œ ìµœì¢… 8ë¶„ë¥˜ -->
<div class="jlpt-card" style="display:flex; gap:8px; flex-wrap:wrap;">
  <button class="jlpt-chip is-on" type="button" data-filter="all">ì „ì²´</button>
  <button class="jlpt-chip" type="button" data-filter="basics">ê¸°ë³¸ë¬¸ì¥</button>
  <button class="jlpt-chip" type="button" data-filter="particles">ì¡°ì‚¬</button>
  <button class="jlpt-chip" type="button" data-filter="exist">ì¡´ì¬/ìœ„ì¹˜</button>
  <button class="jlpt-chip" type="button" data-filter="teform">ã¦í˜•</button>
  <button class="jlpt-chip" type="button" data-filter="tense">ë¶€ì •/ê³¼ê±°</button>
  <button class="jlpt-chip" type="button" data-filter="connect">ì´ìœ /ì—°ê²°</button>
  <button class="jlpt-chip" type="button" data-filter="desire">í¬ë§/ëŠ¥ë ¥</button>
  <button class="jlpt-chip" type="button" data-filter="timefreq">ì‹œê°„/ë¹ˆë„</button>
</div>

<div class="jlpt-card jlpt-note" style="margin-top:12px;">
  <div style="color:#475569; font-weight:700;">
    ğŸ” ë¬¸ë²• ì¹´ë“œëŠ” <b>ì˜ˆë¬¸(ë“£ê¸°)</b> + <b>ìƒí™©(1ì¤„)</b> + <b>í•µì‹¬/ë¶„í•´/ë³€í˜•</b>ê¹Œì§€ ê°™ì´ ë³´ë©´ ë¬¸ì¥ì´ í›¨ì”¬ ë¹¨ë¦¬ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.
  </div>
</div>

<!-- =========================
     ë¬¸ë²• ì¹´ë“œ ìŠ¤íƒ€ì¼(í˜ì´ì§€ ì „ìš©)
========================= -->
<style>
  .g-card{border:1px solid #e5e7eb; border-radius:14px; padding:16px; background:#fff; box-shadow:0 8px 20px rgba(0,0,0,.04); margin-bottom:12px;}
  .g-head{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
  .g-title{font-size:18px; font-weight:950; color:#0b1f4b; margin:0;}
  .g-tag{font-size:12px; font-weight:900; color:#334155; background:#f1f5ff; border:1px solid #dbe7ff; padding:6px 10px; border-radius:999px; white-space:nowrap;}
  .g-desc{margin:8px 0 0; color:#374151; line-height:1.7; font-weight:650; font-size:14px;}
  .g-rule{margin:10px 0 0; padding:10px 12px; border:1px dashed #e5e7eb; border-radius:12px; background:#fbfdff; color:#475569; font-size:13px; line-height:1.7;}
  .g-warn{margin:10px 0 0; padding:10px 12px; border-radius:12px; background:#f8fafc; border:1px solid #e5e7eb; color:#475569; font-size:13px; line-height:1.7;}

  /* âœ… (ì¶”ê°€) í•µì‹¬/ìƒí™©/ë¶„í•´/ì£¼ì˜/ë³€í˜• ë¸”ë¡ */
  .g-extra{margin:12px 0 0; padding:12px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#ffffff;}
  .g-extra .x-row{display:flex; gap:10px; align-items:flex-start; padding:6px 0; border-bottom:1px dashed #eef2f7;}
  .g-extra .x-row:last-child{border-bottom:none;}
  .g-extra .x-k{min-width:60px; font-weight:950; color:#0b1f4b; font-size:13px;}
  .g-extra .x-v{color:#334155; font-weight:750; font-size:13px; line-height:1.7;}
  .x-badge{display:inline-block; margin-right:6px; font-size:12px; font-weight:950; color:#0b1f4b; background:#eef2ff; border:1px solid #dbe7ff; padding:2px 8px; border-radius:999px;}

  /* âœ… ì˜ˆë¬¸ */
  .ex{margin-top:12px; padding-top:12px; border-top:1px solid #eef2f7;}
  .ex-row{display:flex; gap:10px; align-items:flex-start; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eef2f7;}
  .ex-row:last-child{border-bottom:none;}
  .ex-left{flex:1;}
  .ex-jp{font-size:16px; font-weight:900; color:#111827;}
  .ex-pron{margin-top:4px; color:#64748b; font-weight:700; font-size:13px;}
  .ex-ko{margin-top:4px; color:#334155; font-weight:700; font-size:13px;}

  /* âœ… (ì¶”ê°€) ì˜ˆë¬¸ ìƒí™© 1ì¤„ */
  .ex-use{
    margin-top:6px;
    color:#475569;
    font-weight:800;
    font-size:12.5px;
    line-height:1.55;
    background:#f8fafc;
    border:1px solid #e5e7eb;
    padding:6px 10px;
    border-radius:10px;
    display:inline-block;
  }

  /* âœ… (ì¶”ê°€) ë¬¸ë²• í¬ì¸íŠ¸ í•˜ì´ë¼ì´íŠ¸ */
  .hl{
    display:inline-block;
    padding:1px 6px;
    border-radius:8px;
    border:1px solid #fde68a;
    background:#fffbeb;
    color:#92400e;
    font-weight:950;
    box-shadow:0 2px 8px rgba(0,0,0,.04);
  }

  .tts-btn{
    height:36px; padding:0 12px; border-radius:999px; border:1px solid #dbe7ff;
    background:#f1f5ff; color:#0b1f4b; font-weight:900; font-size:13px; cursor:pointer;
    white-space:nowrap;
  }
  .tts-btn:hover{background:#eaf0ff;}
</style>

<!-- âœ… ë¬¸ë²• ì¹´ë“œ ì¶œë ¥ ì˜ì—­ -->
<div id="grammarList"></div>

{% endblock %}

{% block extra_scripts %}
<script>
/* ==========================================================
  âœ… ì„œë²„(app.py)ì—ì„œ ì£¼ì…ë˜ëŠ” ë¬¸ë²• ë°ì´í„°
  - app.pyì—ì„œ grammar_jsonìœ¼ë¡œ ë„˜ê²¨ì¤Œ
========================================================== */
const grammarData = {{ grammar_json|safe }};

/* ==========================================================
  ë Œë” ìœ í‹¸: ì˜ˆë¬¸ í•˜ì´ë¼ì´íŠ¸
  - highlight ë°°ì—´ì— ë“¤ì–´ìˆëŠ” ë¬¸ìì—´ì„ <span class="hl">ë¡œ ê°ìŒ‰ë‹ˆë‹¤.
========================================================== */
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}
function applyHighlight(jp, highlightArr){
  let safe = escapeHtml(jp);
  const hs = (highlightArr || []).filter(Boolean).sort((a,b)=>b.length-a.length);
  hs.forEach(h => {
    const hh = escapeHtml(h);
    safe = safe.split(hh).join(`<span class="hl">${hh}</span>`);
  });
  return safe;
}

/* ==========================================================
  ì¹´ë“œ ë Œë”
========================================================== */
function renderCard(item){
  const exHtml = (item.examples || []).map(ex => {
    const jpHtml = applyHighlight(ex.jp, ex.highlight);
    return `
      <div class="ex-row">
        <div class="ex-left">
          <div class="ex-jp">${jpHtml}</div>
          <div class="ex-pron">${escapeHtml(ex.pron || "")}</div>
          <div class="ex-ko">${escapeHtml(ex.ko || "")}</div>
          ${ex.use ? `<div class="ex-use">âœ… ${escapeHtml(ex.use)}</div>` : ``}
        </div>
        <button class="tts-btn" type="button" data-tts="${escapeHtml(ex.jp)}">ë°œìŒ ë“£ê¸°</button>
      </div>
    `;
  }).join("");

  const extra = item.extra || {};
  const extraHtml = `
    <div class="g-extra">
      <div class="x-row"><div class="x-k">í•µì‹¬</div><div class="x-v">${extra.core || ""}</div></div>
      <div class="x-row"><div class="x-k">ìƒí™©</div><div class="x-v">${escapeHtml(extra.situation || "")}</div></div>
      <div class="x-row"><div class="x-k">ë¶„í•´</div><div class="x-v">${escapeHtml(extra.breakdown || "")}</div></div>
      <div class="x-row"><div class="x-k">ì£¼ì˜</div><div class="x-v">${escapeHtml(extra.caution || "")}</div></div>
      <div class="x-row"><div class="x-k">ë³€í˜•</div><div class="x-v">${escapeHtml(extra.variation || "")}</div></div>
    </div>
  `;

  return `
    <div class="g-card" data-cat="${escapeHtml(item.cat)}">
      <div class="g-head">
        <h3 class="g-title">${escapeHtml(item.title)}</h3>
        <div class="g-tag">${escapeHtml(item.tag || "")}</div>
      </div>
      <p class="g-desc"><b>ì˜ë¯¸:</b> ${escapeHtml(item.desc || "")}</p>
      <div class="g-rule"><b>ì ‘ì†:</b> ${escapeHtml(item.rule || "")}</div>
      <div class="g-warn"><b>í¬ì¸íŠ¸:</b> ${escapeHtml(item.warn || "")}</div>
      ${extraHtml}
      <div class="ex">${exHtml}</div>
    </div>
  `;
}

/* ==========================================================
  ì´ˆê¸° ë Œë”
========================================================== */
(function init(){
  const root = document.getElementById("grammarList");
  root.innerHTML = (grammarData || []).map(renderCard).join("");
})();

/* ==========================================================
  âœ… ì¹© í•„í„°
========================================================== */
(function(){
  const chips = Array.from(document.querySelectorAll('.jlpt-chip[data-filter]'));
  const cards = () => Array.from(document.querySelectorAll('#grammarList .g-card'));

  function setOn(btn){
    chips.forEach(c => c.classList.remove('is-on'));
    btn.classList.add('is-on');
  }

  function applyFilter(key){
    cards().forEach(card => {
      const cat = (card.getAttribute('data-cat') || '').trim();
      card.style.display = (key === 'all' || cat === key) ? '' : 'none';
    });
  }

  chips.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.getAttribute('data-filter');
      setOn(btn);
      applyFilter(key);
    });
  });
})();

/* ==========================================================
  âœ… TTS
========================================================== */
(function () {
  function pickJapaneseVoice() {
    const voices = window.speechSynthesis?.getVoices?.() || [];
    return (
      voices.find(v => v.lang === "ja-JP") ||
      voices.find(v => (v.lang || "").toLowerCase().startsWith("ja")) ||
      null
    );
  }

  function speakJP(text) {
    if (!window.speechSynthesis) return;

    window.speechSynthesis.cancel();
    let t = (text || "").trim();
    if (!t) return;

    if (t.length === 1) t = t + "ã€‚";

    const u = new SpeechSynthesisUtterance(t);
    u.lang = "ja-JP";
    u.volume = 1;
    u.rate = 0.95;
    u.pitch = 1;

    const v = pickJapaneseVoice();
    if (v) u.voice = v;

    window.speechSynthesis.speak(u);
  }

  try { window.speechSynthesis.getVoices(); } catch(e) {}

  document.addEventListener("click", function (e) {
    const btn = e.target.closest(".tts-btn[data-tts]");
    if (!btn) return;
    speakJP(btn.getAttribute("data-tts"));
  });
})();
</script>
{% endblock %}
